<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0F172A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icons/AppImages/ios/180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/AppImages/ios/32.png">
    
    <title>Â≠¶Áîü‰∏≠ÂøÉ | Êô∫ÊÖßÂÆ∂ÊïôÊ°•</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ‚ú® SaaSÂïÜ‰∏öÁ∫ß‰ª™Ë°®Áõò - ÈÅµÂæ™ .cursorrules ÂÆ™Ê≥ï */
        :root { 
            --primary: #6366F1; 
            --primary-dark: #4F46E5;
            --primary-light: #818CF8;
            --primary-glow: rgba(99, 102, 241, 0.5);
            --accent: #A855F7; 
            --gold: #F59E0B; 
            --gold-dark: #D97706;
            --gold-glow: rgba(245, 158, 11, 0.4);
            --success: #10B981;
            --success-glow: rgba(16, 185, 129, 0.4);
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --bg-primary: #0B0F19; 
            --bg-secondary: #0F172A;
            --bg-tertiary: #1E1B4B;
            --bg-card: rgba(22, 27, 40, 0.75); 
            --text: #F8FAFC; 
            --text-gray: #94A3B8;
            --text-muted: #64748B;
            --border: rgba(255, 255, 255, 0.08); 
            --border-light: rgba(255, 255, 255, 0.12);
            --glass-bg: rgba(15, 23, 42, 0.75);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.25);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.35);
            --shadow-glow: 0 0 40px var(--primary-glow);
            
            /* ‰æßËæπÊ†èÂ∞∫ÂØ∏ */
            --sidebar-width: 260px;
            --sidebar-collapsed: 72px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif; }
        body { 
            background: linear-gradient(135deg, #0B0F19 0%, #1E1B4B 50%, #312E81 100%);
            background-attachment: fixed;
            color: var(--text); 
            height: 100vh; 
            display:flex; 
            overflow:hidden; 
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            z-index: -2;
            animation: gradientShift 20s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .aurora-bg { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -1; 
            pointer-events: none; 
            overflow: hidden;
        }
        .blob { 
            position: absolute; 
            filter: blur(100px); 
            opacity: 0.5; 
            animation: float 15s infinite ease-in-out alternate;
            border-radius: 50%;
        }
        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, -50px) scale(1.1); }
        }
        .blob-1 { 
            top: -15%; 
            left: -10%; 
            width: 600px; 
            height: 600px; 
            background: linear-gradient(135deg, var(--primary), var(--accent));
            animation-delay: 0s;
        }
        .blob-2 { 
            bottom: -10%; 
            right: -10%; 
            width: 500px; 
            height: 500px; 
            background: linear-gradient(135deg, var(--accent), var(--gold));
            animation-delay: 5s;
        }
        /* ====== üéõÔ∏è ÂèØÊäòÂè†‰æßËæπÊ†è ====== */
        .sidebar { 
            width: var(--sidebar-width); 
            min-width: var(--sidebar-width);
            background: rgba(11, 15, 25, 0.85); 
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-right: 1px solid var(--border); 
            padding: 24px 16px; 
            display: flex; 
            flex-direction: column; 
            z-index: 100;
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
            min-width: var(--sidebar-collapsed);
            padding: 24px 12px;
        }
        
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .user-info {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }
        
        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 14px;
        }
        
        .sidebar.collapsed .nav-item i {
            margin: 0;
        }
        
        /* ÊäòÂè†ÊåâÈíÆ */
        .sidebar-toggle {
            position: absolute;
            right: -14px;
            top: 70px;
            width: 28px;
            height: 28px;
            background: var(--primary);
            border: 2px solid var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 101;
            transition: all 0.3s ease;
            color: white;
            font-size: 0.75rem;
        }
        
        .sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--primary-glow);
        }
        
        .sidebar.collapsed .sidebar-toggle i {
            transform: rotate(180deg);
        }
        .logo { 
            font-size: 1.3rem; 
            font-weight: 800; 
            color: white; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 32px; 
            cursor: pointer; 
            padding: 0 8px;
            transition: all 0.3s ease;
        }
        
        .logo i {
            color: var(--primary);
            font-size: 1.4rem;
            flex-shrink: 0;
        }
        
        .logo-text {
            background: linear-gradient(135deg, #FFFFFF, #E0E7FF);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .logo:hover { transform: scale(1.02); }
        
        /* ÂØºËà™ÂàÜÁªÑÊ†áÈ¢ò */
        .nav-group-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            padding: 16px 12px 8px;
            font-weight: 600;
        }
        
        .sidebar.collapsed .nav-group-title {
            opacity: 0;
            height: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .nav-item { 
            padding: 12px 16px; 
            color: var(--text-gray); 
            cursor: pointer; 
            border-radius: 12px; 
            margin-bottom: 4px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            font-weight: 500;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
            flex-shrink: 0;
            transition: all 0.25s ease;
        }
        
        .nav-text {
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
            border-radius: 0 3px 3px 0;
            transform: scaleY(0);
            transition: transform 0.25s ease;
        }
        
        .nav-item.active::before {
            transform: scaleY(1);
        }
        
        .nav-item.active { 
            color: white; 
            background: linear-gradient(90deg, rgba(99,102,241,0.2), rgba(99,102,241,0.05));
        }
        
        .nav-item.active i {
            color: var(--primary-light);
        }
        
        .nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nav-item:hover i {
            transform: scale(1.1);
        }
        
        /* ÂØºËà™ÂæΩÁ´† */
        .nav-badge {
            background: var(--danger);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
            font-weight: 600;
        }
        
        .sidebar.collapsed .nav-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            padding: 2px 4px;
            margin: 0;
        }
        .main-content { 
            flex: 1; 
            padding: 32px; 
            overflow-y: auto; 
            position: relative;
            transition: all 0.3s ease;
        }
        
        .main-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at top right, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
                radial-gradient(circle at bottom left, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* ====== üì± ÁßªÂä®Á´ØÂ∫ïÈÉ®ÂØºËà™ ====== */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(11, 15, 25, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 8px 0;
            z-index: 200;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.3);
        }
        
        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
        }
        
        .mobile-nav-item i {
            font-size: 1.2rem;
        }
        
        .mobile-nav-item.active {
            color: var(--primary);
        }
        
        .mobile-nav-item.active i {
            text-shadow: 0 0 15px var(--primary-glow);
        }
        
        /* ====== üìä Êï∞ÊçÆÂèØËßÜÂåñÂç°Áâá ====== */
        .chart-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-title i {
            color: var(--primary);
        }
        
        .chart-container {
            height: 280px;
            width: 100%;
        }
        
        /* ====== üè∑Ô∏è ÂΩ©Ëâ≤ËÉ∂ÂõäÁä∂ÊÄÅÊ†áÁ≠æ ====== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.15);
            color: #FCD34D;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-paid {
            background: rgba(59, 130, 246, 0.15);
            color: #60A5FA;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .status-ongoing {
            background: rgba(16, 185, 129, 0.15);
            color: #34D399;
            border: 1px solid rgba(16, 185, 129, 0.3);
            animation: statusPulse 2s ease-in-out infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
        }
        
        .status-review {
            background: rgba(168, 85, 247, 0.15);
            color: #C084FC;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        
        .status-completed {
            background: rgba(100, 116, 139, 0.15);
            color: #94A3B8;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .status-refund {
            background: rgba(239, 68, 68, 0.15);
            color: #F87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* ====== üîò ËøõÂÖ•ÊïôÂÆ§ËÑâÂÜ≤ÊåâÈíÆ ====== */
        .btn-classroom {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            position: relative;
            overflow: visible;
        }
        
        .btn-classroom::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: inherit;
            background: inherit;
            filter: blur(12px);
            opacity: 0;
            z-index: -1;
            animation: classroomPulse 2s ease-in-out infinite;
        }
        
        @keyframes classroomPulse {
            0%, 100% { opacity: 0; transform: scale(0.9); }
            50% { opacity: 0.6; transform: scale(1); }
        }
        
        .btn-classroom:hover::after {
            opacity: 0.8;
        }
        
        /* ====== üì± ÂìçÂ∫îÂºèËÆæËÆ° ====== */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 200;
            }
            
            .sidebar.mobile-open {
                left: 0;
            }
            
            .mobile-nav {
                display: block;
            }
            
            .main-content {
                padding: 20px;
                padding-bottom: 100px;
            }
            
            body {
                overflow-x: hidden;
            }
        }
        
        @media (max-width: 768px) {
            .wallet-row {
                grid-template-columns: 1fr;
            }
            
            .checkout-layout {
                grid-template-columns: 1fr;
            }
            
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ÁßªÂä®Á´ØÈÅÆÁΩ© */
        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 150;
        }
        
        .mobile-overlay.show {
            display: block;
        }
        .view { 
            display: none; 
            position: relative;
            z-index: 1;
        }
        .view.active { 
            display: block; 
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(15px) scale(0.98); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            } 
        }
        .card { 
            background: var(--bg-card); 
            backdrop-filter: blur(20px) saturate(180%);
            border: 1.5px solid var(--border); 
            border-radius: 24px; 
            padding: 35px; 
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
        }
        .card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 24px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(168, 85, 247, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .card:hover::before {
            opacity: 1;
        }
        .card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }
        
        /* Èí±ÂåÖ‰∏éÁßØÂàÜÂç° - Ë∂ÖÁ∫ßÂ¢ûÂº∫Áâà */
        .wallet-row { 
            display: grid; 
            grid-template-columns: 1.5fr 1fr; 
            gap: 25px; 
            margin-bottom: 30px; 
        }
        .wallet-card { 
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.95), rgba(124, 58, 237, 0.9), rgba(168, 85, 247, 0.85));
            background-size: 200% 200%;
            animation: walletGradient 5s ease infinite;
            border: 1.5px solid rgba(255,255,255,0.2); 
            color: white; 
            border-radius: 28px; 
            padding: 32px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            height: 200px;
            box-shadow: 
                0 12px 40px rgba(79, 70, 229, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            overflow: hidden;
        }
        @keyframes walletGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .wallet-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: walletShine 3s linear infinite;
        }
        @keyframes walletShine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .points-card { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.15));
            border: 1.5px solid rgba(245, 158, 11, 0.4); 
            color: var(--gold); 
            border-radius: 28px; 
            padding: 32px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            height: 200px; 
            position: relative; 
            overflow: hidden;
            box-shadow: 
                0 12px 40px rgba(245, 158, 11, 0.25),
                0 0 0 1px rgba(245, 158, 11, 0.2) inset;
        }
        .points-card::after { 
            content: '\f005'; 
            font-family: 'Font Awesome 6 Free'; 
            font-weight: 900; 
            position: absolute; 
            right: -30px; 
            bottom: -30px; 
            font-size: 12rem; 
            opacity: 0.08; 
            color: var(--gold); 
            pointer-events: none;
            animation: starRotate 20s linear infinite;
        }
        @keyframes starRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .balance-num { 
            font-size: 2.8rem; 
            font-weight: 900; 
            margin-top: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            letter-spacing: -0.02em;
        }
        
        /* ÂïÜÂüéÁΩëÊ†º - Â¢ûÂº∫Áâà */
        .mall-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 24px; 
        }
        .mall-item { 
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(10px);
            border: 1.5px solid var(--border); 
            border-radius: 20px; 
            padding: 24px; 
            text-align: center; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        .mall-item::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .mall-item:hover::before {
            opacity: 1;
        }
        .mall-item:hover { 
            transform: translateY(-8px) scale(1.03);
            border-color: var(--gold);
            box-shadow: 
                0 12px 32px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(245, 158, 11, 0.3),
                0 0 30px rgba(245, 158, 11, 0.2);
        }
        .coin-icon { 
            width: 60px; 
            height: 60px; 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.25), rgba(245, 158, 11, 0.15));
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0 auto 18px; 
            color: var(--gold); 
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
            transition: transform 0.4s ease;
        }
        .mall-item:hover .coin-icon {
            transform: scale(1.15) rotate(10deg);
        }

        .list-item { 
            background: rgba(255, 255, 255, 0.03); 
            backdrop-filter: blur(10px);
            border: 1.5px solid var(--border); 
            padding: 22px; 
            border-radius: 18px; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .list-item:hover { 
            transform: translateX(8px) translateY(-2px); 
            background: rgba(255,255,255,0.08);
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(99, 102, 241, 0.2);
        }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; }
        .btn { 
            padding: 10px 24px; 
            border-radius: 50px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            color: white; 
            font-size: 0.9rem; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn:hover { 
            transform: translateY(-3px) scale(1.02);
        }
        .btn:active { transform: translateY(-1px) scale(0.98); }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light), var(--accent));
            background-size: 200% 200%;
            animation: btnGradient 3s ease infinite;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        @keyframes btnGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .btn-primary:hover {
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5);
        }
        .btn-glass { 
            background: rgba(255,255,255,0.12); 
            border: 1.5px solid rgba(255,255,255,0.25); 
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .btn-glass:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-danger { 
            background: rgba(239, 68, 68, 0.25); 
            color: #EF4444; 
            border: 1.5px solid rgba(239, 68, 68, 0.4);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.35);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        .btn-gold { 
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white; 
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        .btn-gold:hover {
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.5);
        }
        .btn-success { 
            background: rgba(16, 185, 129, 0.25); 
            color: #10B981; 
            border: 1.5px solid rgba(16, 185, 129, 0.4);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }
        .btn-success:hover {
            background: rgba(16, 185, 129, 0.35);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        .btn-link { 
            background: transparent; 
            color: var(--text); 
            border: 1.5px solid var(--border);
        }
        .btn-link:hover {
            border-color: var(--primary);
            color: var(--primary-light);
            background: rgba(99, 102, 241, 0.1);
        }
        .tab-bar { display: flex; gap: 10px; margin-bottom: 25px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 50px; width: fit-content; border: 1px solid var(--border); }
        .tab-btn { background: transparent; border: none; color: #94A3B8; padding: 8px 24px; cursor: pointer; border-radius: 40px; }
        .tab-btn.active { background: rgba(255,255,255,0.1); color: white; }
        
        .overlay { 
            display: none; 
            position: fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,0.88); 
            backdrop-filter:blur(20px) saturate(180%);
            z-index:2000; 
            justify-content:center; 
            align-items:center;
            animation: fadeIn 0.3s ease;
        }
        .modal { 
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(30px) saturate(180%);
            padding: 48px; 
            border-radius: 28px; 
            width: 470px; 
            text-align: center; 
            border: 1.5px solid var(--border);
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                0 0 60px rgba(99, 102, 241, 0.2);
            animation: modalPopIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPopIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .form-input { 
            width: 100%; 
            padding: 16px 20px; 
            background: rgba(11, 15, 25, 0.8);
            backdrop-filter: blur(10px);
            border: 1.5px solid var(--border); 
            color: white; 
            border-radius: 14px; 
            margin: 12px 0; 
            outline:none;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        .form-input:focus {
            border-color: var(--primary);
            background: rgba(11, 15, 25, 0.95);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .fc { color: var(--text); } .fc-button-primary { background-color: var(--primary) !important; border: none !important; }
        .fav-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 24px; 
        }
        .fav-card { 
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(10px);
            border: 1.5px solid var(--border); 
            border-radius: 20px; 
            padding: 24px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .fav-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .fav-card:hover::before {
            opacity: 1;
        }
        .fav-card:hover { 
            transform: translateY(-8px) scale(1.03);
            border-color: var(--primary);
            box-shadow: 
                0 12px 32px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(99, 102, 241, 0.3),
                0 0 30px rgba(99, 102, 241, 0.2);
        }
        .fav-avatar { 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            margin-bottom: 12px; 
            object-fit: cover;
            border: 3px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.4s ease;
        }
        .fav-card:hover .fav-avatar {
            transform: scale(1.1) rotate(5deg);
        }
        
        /* ËÅäÂ§©Ê†∑Âºè - Â¢ûÂº∫Áâà */
        .chat-layout { 
            height: 600px; 
            display: flex; 
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 24px; 
            overflow: hidden; 
            border: 1.5px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .chat-side { 
            width: 260px; 
            border-right: 1.5px solid var(--border); 
            background: rgba(0,0,0,0.25);
            backdrop-filter: blur(10px);
            overflow-y: auto; 
        }
        .chat-item { 
            padding: 16px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            cursor: pointer; 
            transition: all 0.3s ease;
            display: flex; 
            align-items: center; 
            gap: 12px;
        }
        .chat-item:hover, .chat-item.active { 
            background: linear-gradient(90deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1));
            border-left: 3px solid var(--primary);
            padding-left: 13px;
        }
        .chat-main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: rgba(0,0,0,0.15);
        }
        .chat-header { 
            padding: 18px 24px; 
            border-bottom: 1.5px solid var(--border); 
            font-weight: 700; 
            background: rgba(0,0,0,0.25);
            backdrop-filter: blur(10px);
            font-size: 1.1rem;
        }
        .chat-msgs { 
            flex: 1; 
            padding: 24px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 18px; 
        }
        .msg-bubble { 
            max-width: 70%; 
            padding: 12px 18px; 
            border-radius: 18px; 
            line-height: 1.6; 
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            animation: msgPopIn 0.3s ease;
        }
        @keyframes msgPopIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .msg-left { 
            align-self: flex-start; 
            background: linear-gradient(135deg, #334155, #475569);
            color: white; 
            border-bottom-left-radius: 4px;
        }
        .msg-right { 
            align-self: flex-end; 
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white; 
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .chat-input-area { 
            padding: 20px 24px; 
            border-top: 1.5px solid var(--border); 
            display: flex; 
            gap: 12px; 
            background: rgba(0,0,0,0.25);
            backdrop-filter: blur(10px);
        }
        
        /* Á≠æÂà∞Âä®Áîª‰∏éÊîØ‰ªòÊåâÈíÆËÑâÂÜ≤ */
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        .btn-signin { animation: pulse-gold 2s infinite; }
        .btn-signin.disabled { animation: none; filter: grayscale(1); cursor: default; }

        /* ÂçèËÆÆ‰∏éÊî∂Èì∂Âè∞Ê†∑Âºè */
        .contract-paper {
            background: #fff;
            color: #333;
            padding: 30px;
            text-align: left;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.6;
            border: 1px solid #ddd;
        }
        .contract-title { text-align: center; font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .contract-section { margin-bottom: 15px; }
        .contract-bold { font-weight: bold; }

        /* Êî∂Èì∂Âè∞Â∏ÉÂ±Ä */
        .checkout-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; height: 100%; }
        .checkout-left, .checkout-right { display: flex; flex-direction: column; }
        .checkout-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 30px; height: 100%; overflow-y: auto; backdrop-filter: blur(10px); }
        .checkout-info-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .price-large { font-size: 2.5rem; color: var(--gold); font-weight: 800; margin: 20px 0; text-align: right; }
        
        /* ÊîØ‰ªòÊàêÂäüÂä®Áîª */
        .success-checkmark { width: 80px; height: 80px; background: #10B981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .success-checkmark i { font-size: 40px; color: white; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* ÂÖ®Â±Ä Loading Ê†∑Âºè */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ‚ú® Êñ∞Â¢ûÔºöÁîµÂ≠êÁ≠æÂêç‰∏éÂç∞Á´†Ê†∑Âºè --- */
        .signature-box {
            margin-top: 20px; padding: 20px;
            border: 2px dashed #ccc; border-radius: 12px;
            text-align: center; background: rgba(255, 255, 255, 0.02);
            transition: 0.3s;
        }
        .signature-box.signed {
            border-color: #10B981;
            background: rgba(16, 185, 129, 0.05);
        }
        /* Ê®°ÊãüÊâãÂÜôÁ≠æÂêç */
        .hand-signature {
            font-family: 'Brush Script MT', cursive; /* ‰ºòÂÖà‰ΩøÁî®ÊâãÂÜô‰Ωì */
            font-size: 2rem; color: #333;
            transform: rotate(-5deg); display: inline-block;
            padding: 10px 20px; border-bottom: 2px solid #333;
        }
        /* Âç∞Á´† */
        .stamp-seal {
            width: 120px; height: 120px;
            border: 3px solid #EF4444; border-radius: 50%;
            color: #EF4444; font-weight: 900;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            transform: rotate(-20deg) scale(0); /* ÂàùÂßãÈöêËóè */
            opacity: 0;
            position: absolute; bottom: 20px; right: 30px;
            box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.3);
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }
        .stamp-seal.show { transform: rotate(-20deg) scale(1); opacity: 0.8; }
        .stamp-inner {
            border: 1px solid #EF4444; width: 100px; height: 100px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            text-align: center; flex-direction: column;
        }
        .stamp-static {
             position: absolute; bottom: 80px; right: 50px;
            width: 100px; height: 100px;
            border: 3px solid #EF4444; border-radius: 50%;
            color: #EF4444; font-weight: 900; display: flex;
            align-items: center; justify-content: center;
            font-size: 1.2rem; transform: rotate(-20deg);
            opacity: 0.8; pointer-events: none;
            text-transform: uppercase;
            box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>
    <div class="aurora-bg"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <div class="loading-overlay" id="globalLoading">
        <div class="spinner"></div>
        <div style="color: white; font-weight: bold;">Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂÄô...</div>
    </div>

    <!-- ÁßªÂä®Á´ØÈÅÆÁΩ© -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileSidebar()"></div>
    
    <div class="sidebar" id="mainSidebar">
        <!-- ÊäòÂè†ÊåâÈíÆ -->
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left"></i>
        </div>
        
        <div class="logo" onclick="location.href='index.html'">
            <i class="fas fa-graduation-cap"></i>
            <span class="logo-text">Â≠¶Áîü‰∏≠ÂøÉ</span>
        </div>
        
        <div class="nav-group-title">Ê¶ÇËßà</div>
        <div class="nav-item active" onclick="switchView('home', this)">
            <i class="fas fa-th-large"></i>
            <span class="nav-text">Êï∞ÊçÆÁúãÊùø</span>
        </div>
        
        <div class="nav-group-title">Â≠¶‰π†</div>
        <div class="nav-item" onclick="switchView('courses', this)" id="nav-courses">
            <i class="fas fa-book-open"></i>
            <span class="nav-text">ÊàëÁöÑËØæÁ®ã</span>
        </div>
        <div class="nav-item" onclick="switchView('resources', this)">
            <i class="fas fa-folder-open"></i>
            <span class="nav-text">ÊàëÁöÑËµÑÊñô</span>
        </div>
        <div class="nav-item" onclick="switchView('calendar', this)">
            <i class="fas fa-calendar-alt"></i>
            <span class="nav-text">ËØæÁ®ãÊó•ÂéÜ</span>
        </div>
        
        <div class="nav-group-title">Ê∏∏ÊàèÂåñ</div>
        <div class="nav-item" onclick="switchView('achievements', this)">
            <i class="fas fa-trophy"></i>
            <span class="nav-text">ÊàêÂ∞±Â¢ô</span>
        </div>
        <div class="nav-item" onclick="switchView('points_center', this)">
            <i class="fas fa-star"></i>
            <span class="nav-text">ÁßØÂàÜ‰∏≠ÂøÉ</span>
        </div>
        
        <div class="nav-group-title">ÊúçÂä°</div>
        <div class="nav-item" onclick="switchView('demands', this)">
            <i class="fas fa-bullhorn"></i>
            <span class="nav-text">ÊàëÁöÑÈúÄÊ±Ç</span>
        </div>
        <div class="nav-item" onclick="switchView('favorites', this)">
            <i class="fas fa-heart"></i>
            <span class="nav-text">ÊàëÁöÑÊî∂Ëóè</span>
        </div>
        
        <div class="nav-group-title">Ê∂àÊÅØ</div>
        <div class="nav-item" onclick="switchView('notifs', this)">
            <i class="fas fa-bell"></i>
            <span class="nav-text">Á≥ªÁªüÈÄöÁü•</span>
            <span class="nav-badge" id="navDot" style="display:none">0</span>
        </div>
        <div class="nav-item" onclick="switchView('messages', this)">
            <i class="fas fa-comment-dots"></i>
            <span class="nav-text">Â∏àÁîüÁßÅ‰ø°</span>
        </div>
        
        <div style="flex:1"></div>
        
        <div class="nav-item" onclick="switchView('profile', this)">
            <i class="fas fa-user-cog"></i>
            <span class="nav-text">‰∏™‰∫∫ËÆæÁΩÆ</span>
        </div>
        <div class="nav-item" onclick="location.href='index.html'" style="color:#EF4444">
            <i class="fas fa-sign-out-alt"></i>
            <span class="nav-text">ÈÄÄÂá∫Á≥ªÁªü</span>
        </div>
    </div>
    
    <!-- ÁßªÂä®Á´ØÂ∫ïÈÉ®ÂØºËà™ -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <div class="mobile-nav-item active" onclick="switchView('home')">
                <i class="fas fa-th-large"></i>
                <span>Ê¶ÇËßà</span>
            </div>
            <div class="mobile-nav-item" onclick="switchView('courses')">
                <i class="fas fa-book-open"></i>
                <span>ËØæÁ®ã</span>
            </div>
            <div class="mobile-nav-item" onclick="switchView('messages')">
                <i class="fas fa-comment-dots"></i>
                <span>Ê∂àÊÅØ</span>
            </div>
            <div class="mobile-nav-item" onclick="switchView('profile')">
                <i class="fas fa-user"></i>
                <span>ÊàëÁöÑ</span>
            </div>
            <div class="mobile-nav-item" onclick="toggleMobileSidebar()">
                <i class="fas fa-bars"></i>
                <span>Êõ¥Â§ö</span>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div id="view-home" class="view active">
            <!-- È°∂ÈÉ®Ê¨¢ËøéÊ†è -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:28px; flex-wrap:wrap; gap:16px;">
                <div>
                    <h2 style="margin:0 0 4px 0; font-size:1.5rem;">üëã Ê¨¢ËøéÂõûÊù•Ôºå<span id="uNameDisplay">ÂêåÂ≠¶</span></h2>
                    <p style="margin:0; color:var(--text-muted); font-size:0.9rem;">‰ªäÂ§©‰πüË¶ÅÂä†Ê≤πÂ≠¶‰π†Âì¶ÔºÅ</p>
                </div>
                <button class="btn btn-gold btn-signin" id="signinBtn" onclick="doSignin()">
                    <i class="fas fa-calendar-check"></i> ÊØèÊó•Á≠æÂà∞
                </button>
            </div>
            
            <!-- ÁªüËÆ°Âç°ÁâáË°å -->
            <div class="stats-row" style="display:grid; grid-template-columns:repeat(4,1fr); gap:20px; margin-bottom:28px;">
                <div class="stat-mini-card" style="background:linear-gradient(135deg, rgba(99,102,241,0.2), rgba(99,102,241,0.05)); border:1px solid rgba(99,102,241,0.3); border-radius:16px; padding:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:0.8rem; color:var(--text-gray); margin-bottom:8px;">Á¥ØËÆ°Â≠¶‰π†</div>
                            <div style="font-size:1.8rem; font-weight:800; color:var(--primary-light);" id="statHours">0<span style="font-size:0.9rem; font-weight:400;">h</span></div>
                        </div>
                        <div style="width:40px; height:40px; background:rgba(99,102,241,0.2); border-radius:12px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-clock" style="color:var(--primary-light);"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-mini-card" style="background:linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.05)); border:1px solid rgba(16,185,129,0.3); border-radius:16px; padding:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:0.8rem; color:var(--text-gray); margin-bottom:8px;">ÂÆåÊàêËØæÁ®ã</div>
                            <div style="font-size:1.8rem; font-weight:800; color:#34D399;" id="statCourses">0</div>
                        </div>
                        <div style="width:40px; height:40px; background:rgba(16,185,129,0.2); border-radius:12px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-check-circle" style="color:#34D399;"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-mini-card" style="background:linear-gradient(135deg, rgba(245,158,11,0.2), rgba(245,158,11,0.05)); border:1px solid rgba(245,158,11,0.3); border-radius:16px; padding:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:0.8rem; color:var(--text-gray); margin-bottom:8px;">Èí±ÂåÖ‰ΩôÈ¢ù</div>
                            <div style="font-size:1.8rem; font-weight:800; color:#FCD34D;">¬•<span id="uBalance">0</span></div>
                        </div>
                        <div style="width:40px; height:40px; background:rgba(245,158,11,0.2); border-radius:12px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-wallet" style="color:#FCD34D;"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-mini-card" style="background:linear-gradient(135deg, rgba(168,85,247,0.2), rgba(168,85,247,0.05)); border:1px solid rgba(168,85,247,0.3); border-radius:16px; padding:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:0.8rem; color:var(--text-gray); margin-bottom:8px;">‰ºöÂëòÁßØÂàÜ</div>
                            <div style="font-size:1.8rem; font-weight:800; color:#C084FC;" id="uPoints">0</div>
                        </div>
                        <div style="width:40px; height:40px; background:rgba(168,85,247,0.2); border-radius:12px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-star" style="color:#C084FC;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Êï∞ÊçÆÂèØËßÜÂåñÂõæË°® -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-chart-line"></i>
                        Â≠¶‰π†Êó∂ÈïøË∂ãÂäø
                    </div>
                    <select id="chartPeriod" onchange="updateStudyChart()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:white; padding:6px 12px; border-radius:8px; outline:none;">
                        <option value="7">Ëøë7Â§©</option>
                        <option value="30">Ëøë30Â§©</option>
                    </select>
                </div>
                <div class="chart-container" id="studyChart"></div>
            </div>
            
            <!-- Èí±ÂåÖ‰∏éÁßØÂàÜ -->
            <div class="wallet-row">
                <div class="wallet-card">
                    <div>
                        <div style="font-size:0.85rem; opacity:0.8; margin-bottom:8px;">Èí±ÂåÖ‰ΩôÈ¢ù (CNY)</div>
                        <div class="balance-num">¬• <span id="uBalanceBig">0.00</span></div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-glass" onclick="recharge()">
                            <i class="fas fa-plus"></i> ÂÖÖÂÄº
                        </button>
                    </div>
                </div>
                <div class="points-card">
                    <div>
                        <div style="font-size:0.85rem; opacity:0.8; margin-bottom:8px;">‰ºöÂëòÁßØÂàÜ</div>
                        <div class="balance-num" style="font-size:2.2rem"><span id="uPointsBig">0</span></div>
                    </div>
                    <div style="font-size:0.8rem; opacity:0.7;">ÁßØÂ∞ëÊàêÂ§öÔºåÂÖëÊç¢Â•ΩÁ§º</div>
                </div>
            </div>

            <!-- ÁßØÂàÜÂïÜÂüé -->
            <div class="card">
                <h3 style="margin-bottom:20px; color:var(--gold); display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-gift"></i> ÁßØÂàÜÂïÜÂüé 
                    <span style="font-size:0.75rem; color:var(--text-muted); font-weight:normal;">ÂÖëÊç¢ÂêéËá™Âä®ÊîæÂÖ•Âà∏ÂåÖ</span>
                </h3>
                <div class="mall-grid" id="mallList">
                    <div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-muted);">
                        <i class="fas fa-spinner fa-spin" style="font-size:2rem; margin-bottom:12px;"></i>
                        <p>Âä†ËΩΩ‰∏≠...</p>
                    </div>
                </div>
            </div>

            <!-- ‰ºòÊÉ†Âà∏ -->
            <div class="card" style="margin-top:24px;">
                <h3 style="margin-bottom:20px; color:var(--text-gray); display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-ticket-alt"></i> ÊàëÁöÑ‰ºòÊÉ†Âà∏
                </h3>
                <div id="couponList" style="display:flex; gap:15px; flex-wrap:wrap;">
                    <div style="color:var(--text-muted);">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
            
            <!-- Ë¥¶ÂçïÊòéÁªÜ -->
            <div class="card" style="margin-top:24px;">
                <h3 style="margin-bottom:20px; color:var(--text-gray); display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-receipt"></i> Ë¥¶ÂçïÊòéÁªÜ
                </h3>
                <div id="billList"></div>
            </div>
        </div>

        <div id="view-courses" class="view">
            <h2 style="margin-bottom:30px;">ÊàëÁöÑËØæÁ®ã</h2>
            <div class="card">
                <div class="tab-bar"><button class="tab-btn active" onclick="filterCourses('all', this)" id="tab-all">ÂÖ®ÈÉ®</button><button class="tab-btn" onclick="filterCourses('pay', this)" id="tab-pay">ÂæÖÊîØ‰ªò</button><button class="tab-btn" onclick="filterCourses('wait', this)" id="tab-wait">ÂæÖ‰∏äËØæ</button><button class="tab-btn" onclick="filterCourses('review', this)">ÂæÖËØÑ‰ª∑</button></div>
                <div id="courseList"></div>
            </div>
        </div>

        <div id="view-resources" class="view"><h2 style="margin-bottom:30px;">üìÇ ÊàëÁöÑËµÑÊñôÂ∫ì</h2><div class="card"><p style="color:#94A3B8; margin-bottom:20px;">ËøôÈáåÂ≠òÊîæÊÇ®Âú®ÂïÜÂüéË¥≠‰π∞ÁöÑÊâÄÊúâÂ≠¶‰π†ËµÑÊñôÔºåÊîØÊåÅÊ∞∏‰πÖÈáçÂ§ç‰∏ãËΩΩ„ÄÇ</p><div id="myResList">Âä†ËΩΩ‰∏≠...</div></div></div>

        <div id="view-demands" class="view"><h2 style="margin-bottom:30px;">üì£ ÊàëÁöÑÈúÄÊ±Ç <button class="btn btn-primary" style="float:right" onclick="document.getElementById('demandModal').style.display='flex'">+ ÂèëÂ∏ÉÊñ∞ÈúÄÊ±Ç</button></h2><div class="card"><div id="demandList">Âä†ËΩΩ‰∏≠...</div></div></div>

        <div id="view-calendar" class="view"><h2 style="margin-bottom:30px;">üìÖ ËØæÁ®ãÊó•ÂéÜ</h2><div class="card" style="background:#161B28;"><div id='calendar'></div></div></div>
        
        <div id="view-favorites" class="view"><h2 style="margin-bottom:30px;">‚ù§Ô∏è ÊàëÊî∂ËóèÁöÑËÄÅÂ∏à</h2><div class="card"><div class="fav-grid" id="favList"></div></div></div>

        <div id="view-notifs" class="view"><h2 style="margin-bottom:30px;">üîî Á≥ªÁªüÈÄöÁü•</h2><div class="card" id="notifList">ÊöÇÊó†ÈÄöÁü•</div></div>

        <div id="view-messages" class="view"><h2 style="margin-bottom:30px;">üí¨ Â∏àÁîüÁßÅ‰ø°</h2><div class="chat-layout"><div class="chat-side" id="contactList"><div style="padding:20px; color:gray; text-align:center;">Âä†ËΩΩ‰∏≠...</div></div><div class="chat-main"><div class="chat-header" id="chatHeader">ËØ∑ÈÄâÊã©ËÄÅÂ∏àÂºÄÂßãËÅäÂ§©</div><div class="chat-msgs" id="chatMsgs"></div><div class="chat-input-area"><input id="msgInput" class="form-input" style="margin:0; border-radius:30px;" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."><button class="btn btn-primary" style="border-radius:30px; width:50px; justify-content:center;" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button></div></div></div></div>

        <div id="view-achievements" class="view">
            <h2 style="margin-bottom:30px;">üèÜ ÊàêÂ∞±Â¢ô</h2>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0;">ÊàëÁöÑÊàêÂ∞±</h3>
                    <span style="color:var(--gold); font-weight:600;">
                        Â∑≤Ëß£ÈîÅ <span id="unlockedCount">0</span> / <span id="totalBadges">0</span>
                    </span>
                </div>
                <div class="achievement-grid" id="achievementGrid"></div>
            </div>
        </div>

        <div id="view-points_center" class="view">
            <h2 style="margin-bottom:30px;">‚≠ê ÁßØÂàÜ‰∏≠ÂøÉ</h2>
            
            <!-- Á≠âÁ∫ßËøõÂ∫¶Âç°Áâá -->
            <div class="level-progress-card">
                <div class="level-header">
                    <div class="level-info">
                        <h3 id="levelName">ÈùíÈìúÂ≠¶Âëò</h3>
                        <p>ÂΩìÂâçÁßØÂàÜÔºö<span id="currentPoints">0</span></p>
                    </div>
                    <div class="level-number" id="levelNumber">LV.1</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span>ËøòÈúÄ <span id="neededPoints">500</span> ÁßØÂàÜÂçáÁ∫ß</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            
            <!-- Á≠æÂà∞Âç°Áâá -->
            <div class="card">
                <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-calendar-check" style="color:var(--gold);"></i> ÊØèÊó•Á≠æÂà∞
                </h3>
                <div style="text-align:center; padding:20px;">
                    <button class="btn btn-gold btn-signin" id="centerSigninBtn" onclick="doSigninWithConfetti()" style="font-size:1.1rem; padding:16px 40px;">
                        <i class="fas fa-calendar-check"></i> Á´ãÂç≥Á≠æÂà∞
                    </button>
                    <p style="color:var(--text-gray); margin-top:16px; font-size:0.9rem;">
                        ËøûÁª≠Á≠æÂà∞ÂèØËé∑ÂæóÊõ¥Â§öÁßØÂàÜÂ•ñÂä±
                    </p>
                </div>
            </div>
            
            <!-- ÁßØÂàÜÂïÜÂüé -->
            <div class="card">
                <h3 style="margin-bottom:20px; color:var(--gold); display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-gift"></i> ÁßØÂàÜÂïÜÂüé
                    <span style="font-size:0.75rem; color:var(--text-muted); font-weight:normal;">ÂÖëÊç¢ÂêéËá™Âä®ÊîæÂÖ•Âà∏ÂåÖ</span>
                </h3>
                <div class="mall-grid" id="pointsMallList">
                    <div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-muted);">
                        <i class="fas fa-spinner fa-spin" style="font-size:2rem; margin-bottom:12px;"></i>
                        <p>Âä†ËΩΩ‰∏≠...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-profile" class="view"><div class="card" style="max-width:600px;"><h3>ËµÑÊñôËÆæÁΩÆ</h3><br><input type="text" id="upName" class="form-input" placeholder="ÊòµÁß∞"><button class="btn btn-primary" onclick="saveProfile()" style="width:100%">‰øùÂ≠ò</button></div></div>

        <div id="view-checkout" class="view">
            <h2 style="margin-bottom:30px;"><i class="fas fa-cash-register"></i> Êî∂Èì∂Âè∞</h2>
            <div class="checkout-layout">
                <div class="checkout-left">
                    <div class="checkout-box" style="position:relative;">
                        <h3 style="margin-bottom:20px; color:var(--primary);">1. Á≠æÁΩ≤ÊúçÂä°ÂçèËÆÆ</h3>
                        
                        <div class="contract-paper" id="checkoutContractContent" style="height: 350px;">
                        </div>

                        <div id="signActionArea" class="signature-box">
                            <p style="color:#94A3B8; margin-bottom:15px; font-size:0.9rem;">
                                ËØ∑ÈòÖËØª‰∏äÊñπÂçèËÆÆÔºåÁ°ÆËÆ§Êó†ËØØÂêéÁÇπÂáª‰∏ãÊñπÊåâÈíÆËøõË°åÁîµÂ≠êÁ≠æÁΩ≤
                            </p>
                            <button id="btn-do-sign" class="btn btn-primary" onclick="signContract()">
                                <i class="fas fa-file-signature"></i> ÁÇπÂáªÁ≠æÁΩ≤ / Sign
                            </button>
                            </div>

                        <div id="signedDisplayArea" class="signature-box signed" style="display:none;">
                            <p style="color:#10B981; margin-bottom:10px;">
                                <i class="fas fa-check-circle"></i> ÂçèËÆÆÂ∑≤Á≠æÁΩ≤
                            </p>
                            <div class="hand-signature" id="myHandSignature">User Name</div>
                            <div style="font-size:0.8rem; color:gray; margin-top:5px;">
                                Á≠æÁΩ≤Êó∂Èó¥Ôºö<span id="signedTime"></span>
                            </div>
                        </div>

                        <div id="contractStamp" class="stamp-seal">
                            <div class="stamp-inner">Êô∫ÊÖßÂÆ∂Êïô<br>ÂçèËÆÆ‰∏ìÁî®Á´†</div>
                        </div>
                    </div>
                </div>

                <div class="checkout-right">
                    <div class="checkout-box">
                        <h3 style="margin-bottom:20px; color:var(--accent);">2. Á°ÆËÆ§ËÆ¢Âçï & ÊîØ‰ªò</h3>
                        <div style="margin-bottom:30px;">
                            <div class="checkout-info-row"><span>ÊéàËØæËÄÅÂ∏à</span><span id="coTutor" style="font-weight:bold"></span></div>
                            <div class="checkout-info-row"><span>ÊéàËØæÊñπÂºè</span><span id="coClassType" style="font-weight:bold; color:var(--primary)"></span></div>
                            <div class="checkout-info-row"><span>‰∏äËØæÊó∂Èó¥</span><span id="coTime"></span></div>
                            <div class="checkout-info-row"><span>ËÆ¢ÂçïÂéü‰ª∑</span><span id="coOriginal"></span></div>
                        </div>
                        
                        <div style="margin-bottom:30px;">
                            <label style="display:block; margin-bottom:10px; color:#94A3B8;">‰ΩøÁî®‰ºòÊÉ†Âà∏</label>
                            <select id="coCouponSelect" class="form-input" onchange="calcCheckoutPrice()"></select>
                        </div>

                        <div style="margin-top:auto;">
                            <div style="text-align:right; color:#94A3B8;">ÂÆû‰ªòÈáëÈ¢ù</div>
                            <div class="price-large">¬• <span id="coFinal">0.00</span></div>
                            
                            <button id="btn-final-pay" class="btn btn-primary" 
                                    style="width:100%; padding:15px; font-size:1.1rem; opacity:0.5; cursor:not-allowed; filter: grayscale(1);" 
                                    disabled 
                                    onclick="confirmCheckout()">
                                üîí ËØ∑ÂÖàÂú®Â∑¶‰æßÁ≠æÁΩ≤ÂçèËÆÆ
                            </button>
                            <button class="btn btn-link" style="width:100%; margin-top:10px;" onclick="switchView('courses')">ÂèñÊ∂àÊîØ‰ªò</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="demandModal"><div class="modal"><h3>üìù ÂèëÂ∏ÉÂÆ∂ÊïôÈúÄÊ±Ç</h3><input type="text" id="dmSubject" class="form-input" placeholder="ÁßëÁõÆ"><input type="text" id="dmGrade" class="form-input" placeholder="Âπ¥Á∫ß"><input type="number" id="dmBudget" class="form-input" placeholder="È¢ÑÁÆó"><textarea id="dmReq" class="form-input" rows="3" placeholder="ËØ¶ÁªÜË¶ÅÊ±Ç"></textarea><button class="btn btn-primary" style="width:100%" onclick="postDemand()">Á´ãÂç≥ÂèëÂ∏É</button><button class="btn" style="background:transparent; color:gray; margin-top:10px" onclick="document.getElementById('demandModal').style.display='none'">ÂèñÊ∂à</button></div></div>
    <div class="overlay" id="applyModal"><div class="modal" style="width:600px;"><h3 style="margin-bottom:20px;">üôã‚Äç‚ôÇÔ∏è Â∫îËÅòËÄÅÂ∏àÂàóË°®</h3><div id="applyList" style="max-height:400px; overflow-y:auto; text-align:left;"></div><button class="btn" style="background:transparent; color:gray; margin-top:15px" onclick="document.getElementById('applyModal').style.display='none'">ÂÖ≥Èó≠</button></div></div>
    <div class="overlay" id="reviewModal"><div class="modal"><h3>üåü ËØæÁ®ãËØÑ‰ª∑</h3><select id="ratingSelect" class="form-input" style="text-align:center;"><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option></select><input type="text" id="reviewContent" class="form-input" placeholder="ÂÜôÁÇπËØÑ‰ª∑Âêß..."><button class="btn btn-primary" style="width:100%" onclick="submitReview()">Êèê‰∫§</button><button class="btn" style="background:transparent; color:gray; margin-top:10px" onclick="document.getElementById('reviewModal').style.display='none'">ÂèñÊ∂à</button></div></div>
    <div class="overlay" id="msgDetailModal"><div class="modal" style="width:500px; text-align:left;"><h3 id="msgDetailTitle" style="margin-bottom:20px; color:var(--accent);">Ê∂àÊÅØËØ¶ÊÉÖ</h3><div id="msgDetailContent" style="line-height:1.8; color:var(--text-gray); white-space: pre-wrap; max-height:400px; overflow-y:auto;"></div><div style="text-align:center; margin-top:30px;"><button class="btn btn-primary" onclick="document.getElementById('msgDetailModal').style.display='none'">ÂÖ≥Èó≠</button></div></div></div>

    <div class="overlay" id="contractViewModal">
        <div class="modal" style="width: 700px; position:relative;">
            <h3 style="margin-bottom:20px; color:white;">üìÉ Â∑≤Á≠æÁΩ≤ÂçèËÆÆ</h3>
            <div class="contract-paper" id="viewContractContent"></div>
            <div class="stamp-static">Â∑≤Á≠æÁΩ≤</div>
            <button class="btn" style="background:transparent; color:gray; margin-top:10px" onclick="document.getElementById('contractViewModal').style.display='none'">ÂÖ≥Èó≠Á™óÂè£</button>
        </div>
    </div>

    <div class="overlay" id="paySuccessModal">
        <div class="modal" style="text-align:center; width: 400px;">
            <div class="success-checkmark"><i class="fas fa-check"></i></div>
            <h2 style="margin-bottom:10px; color:white;">ÊîØ‰ªòÊàêÂäüÔºÅ</h2>
            <p style="color:#94A3B8; margin-bottom:25px;">¬• <span id="successAmount">0.00</span> Â∑≤ÊîØ‰ªòÔºåÂçèËÆÆÂ∑≤Ëá™Âä®ÂΩíÊ°£</p>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:rgba(255,255,255,0.1); border:1px solid var(--border);" onclick="location.href='index.html'">ËøîÂõûÈ¶ñÈ°µ</button>
                <button class="btn btn-primary" style="flex:1;" onclick="goToWaitClass()">Êü•ÁúãËØæÁ®ã</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="refundModal">
        <div class="modal">
            <h3>üí∏ Áî≥ËØ∑ÈÄÄÊ¨æ</h3>
            <div style="text-align:left; margin-top:15px; margin-bottom:5px; color:#94A3B8; font-size:0.9rem;">ÈÄÄÊ¨æÂéüÂõ†</div>
            <select id="refundReason" class="form-input">
                <option value="ËÄÅÂ∏àÊú™ÊåâÊó∂‰∏äËØæ">ËÄÅÂ∏àÊú™ÊåâÊó∂‰∏äËØæ</option>
                <option value="ÊïôÂ≠¶Ë¥®Èáè‰∏çÊª°ÊÑè">ÊïôÂ≠¶Ë¥®Èáè‰∏çÊª°ÊÑè</option>
                <option value="Êó∂Èó¥ÂÜ≤Á™Å/ÂçèÂïÜ‰∏ÄËá¥">Êó∂Èó¥ÂÜ≤Á™Å/ÂçèÂïÜ‰∏ÄËá¥</option>
                <option value="ÂÖ∂‰ªñÂéüÂõ†">ÂÖ∂‰ªñÂéüÂõ†</option>
            </select>
            <div style="text-align:left; margin-top:10px; margin-bottom:5px; color:#94A3B8; font-size:0.9rem;">ËØ¶ÁªÜËØ¥Êòé</div>
            <textarea id="refundDesc" class="form-input" rows="3" placeholder="ËØ∑ËØ¶ÁªÜÊèèËø∞ÂÖ∑‰ΩìÊÉÖÂÜµÔºå‰ª•‰æøÂø´ÈÄüÂÆ°Ê†∏..."></textarea>
            <button class="btn btn-primary" style="width:100%" onclick="doRefundSubmit()">Êèê‰∫§Áî≥ËØ∑</button>
            <button class="btn" style="background:transparent; color:gray; margin-top:10px" onclick="document.getElementById('refundModal').style.display='none'">ÂèñÊ∂à</button>
        </div>
    </div>

    <script>
        const phone = localStorage.getItem('userPhone');
        let allBookings = [], myCoupons = [], calendar = null;
        let currentReviewId = 0, currentRefundId = 0;
        let checkoutData = {}; 
        let currentChatTarget = null;
        let chatInterval = null;
        let studyChart = null;
        
        // ‚ú® ÂçèËÆÆÁ≠æÁΩ≤Áä∂ÊÄÅÂèòÈáè
        let isCurrentContractSigned = false; 

        if(!phone) location.href='index.html';
        
        document.addEventListener('DOMContentLoaded', () => {
            loadInfo(); 
            loadCourses(); 
            loadBills(); 
            loadCoupons(); 
            checkNotifs(); 
            initCalendar();
            loadPointsData();
            initStudyChart(); // ÂàùÂßãÂåñÂ≠¶‰π†ÂõæË°®
            loadStudentStats(); // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
            loadWalletAndPoints(); // Âä†ËΩΩÈí±ÂåÖÂíåÁßØÂàÜ
            
            const params = new URLSearchParams(window.location.search);
            if(params.get('view') === 'courses') switchView('courses', document.getElementById('nav-courses'));
            
            // ÊÅ¢Â§ç‰æßËæπÊ†èÁä∂ÊÄÅ
            if(localStorage.getItem('sidebarCollapsed') === 'true') {
                const sidebar = document.getElementById('mainSidebar');
                if(sidebar) sidebar.classList.add('collapsed');
            }
        });
        
        // ====== üéõÔ∏è ‰æßËæπÊ†èÊéßÂà∂ ======
        function toggleSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
        
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
        }
        
        // ====== üìä ECharts Â≠¶‰π†Êó∂ÈïøÂõæË°® ======
        function initStudyChart() {
            const chartDom = document.getElementById('studyChart');
            if (!chartDom) return;
            
            studyChart = echarts.init(chartDom, null, { renderer: 'canvas' });
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    borderColor: 'rgba(99, 102, 241, 0.3)',
                    textStyle: { color: '#F8FAFC' },
                    formatter: '{b}<br/>Â≠¶‰π†Êó∂Èïø: {c}Â∞èÊó∂'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: [],
                    axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                    axisLabel: { color: '#94A3B8', fontSize: 11 },
                    splitLine: { show: false }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    axisLabel: { color: '#94A3B8', fontSize: 11 },
                    splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
                },
                series: [{
                    name: 'Â≠¶‰π†Êó∂Èïø',
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    lineStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#6366F1' },
                            { offset: 1, color: '#A855F7' }
                        ]),
                        width: 3
                    },
                    itemStyle: {
                        color: '#818CF8',
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(99, 102, 241, 0.3)' },
                            { offset: 1, color: 'rgba(99, 102, 241, 0.02)' }
                        ])
                    },
                    data: []
                }]
            };
            
            studyChart.setOption(option);
            window.addEventListener('resize', () => studyChart?.resize());
            
            updateStudyChart();
        }
        
        function updateStudyChart() {
            if (!studyChart) return;
            
            const days = parseInt(document.getElementById('chartPeriod')?.value || 7);
            const labels = [];
            const data = [];
            
            // ÁîüÊàêÊ®°ÊãüÊï∞ÊçÆÔºàÂÆûÈôÖÂ∫î‰ªéÂêéÁ´ØËé∑ÂèñÔºâ
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(`${date.getMonth() + 1}/${date.getDate()}`);
                data.push(Math.round(Math.random() * 3 * 10) / 10 + 0.5); // 0.5-3.5Â∞èÊó∂
            }
            
            studyChart.setOption({
                xAxis: { data: labels },
                series: [{ data: data }]
            });
        }
        
        // Âä†ËΩΩÂ≠¶ÁîüÁªüËÆ°Êï∞ÊçÆ
        function loadStudentStats() {
            // ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
            fetch(`api/user_api.php?action=get_my_bookings&phone=${phone}&_t=${Date.now()}`)
                .then(r => r.json())
                .then(res => {
                    const bookings = res.data || [];
                    const completed = bookings.filter(b => b.status === 'Â∑≤ÂÆåÊàê' || b.status === 'ÂæÖËØÑ‰ª∑').length;
                    const hours = completed * 2; // ÂÅáËÆæÊØèËäÇËØæ2Â∞èÊó∂
                    
                    document.getElementById('statHours').innerHTML = `${hours}<span style="font-size:0.9rem;font-weight:400;">h</span>`;
                    document.getElementById('statCourses').innerText = completed;
                });
        }

        function switchView(id, btn) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(btn) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); btn.classList.add('active'); }
            if(id === 'calendar' && calendar) setTimeout(() => { calendar.render(); }, 100);
            if(id === 'favorites') loadFavorites();
            if(id === 'messages') loadContacts(); 
            if(id === 'notifs') loadNotifs();
            if(id === 'resources') loadMyResources();
            if(id === 'demands') loadDemands();
            if(id === 'achievements') loadAchievements();
            if(id === 'points_center') loadPointsCenter();
        }

        // --- ÂÖ®Â±Ä Loading ÊéßÂà∂ ---
        function showLoading() { document.getElementById('globalLoading').style.display = 'flex'; }
        function hideLoading() { document.getElementById('globalLoading').style.display = 'none'; }

        // --- Ê†∏ÂøÉÈÄªËæëÔºöËØæÁ®ãÊ∏≤ÊüìÔºàÂΩ©Ëâ≤ËÉ∂ÂõäÊ†áÁ≠æ + ËÑâÂÜ≤ÊåâÈíÆÔºâ---
        function filterCourses(type, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            
            let list = allBookings;
            if (type === 'pay') list = allBookings.filter(b => b.status === 'Â∑≤ÈÄöËøá');
            if (type === 'wait') list = allBookings.filter(b => b.status === 'Â∑≤ÊîØ‰ªò' || b.status === 'ÈÄÄÊ¨æ‰∏≠');
            if (type === 'review') list = allBookings.filter(b => b.status === 'ÂæÖËØÑ‰ª∑');
            
            let h = '';
            if (list.length === 0) {
                h = `<div style="text-align:center;padding:60px 20px;color:var(--text-muted)">
                        <i class="fas fa-inbox" style="font-size:3.5rem;margin-bottom:20px;opacity:0.3"></i>
                        <p style="font-size:1rem;">ÊöÇÊó†Áõ∏ÂÖ≥ËÆ¢Âçï</p>
                        <a href="index.html" style="color:var(--primary); font-size:0.9rem;">ÂéªÊâæËÄÅÂ∏à ‚Üí</a>
                     </div>`;
            } else {
                list.forEach((b, index) => {
                    let btnHtml = '';
                    let statusBadge = '';
                    let myName = document.getElementById('uNameDisplay').innerText;
                    let cType = b.class_type || 'Á∫ø‰∏äÊïôÂ≠¶';
                    
                    // Êü•ÁúãÂçèËÆÆÊåâÈíÆ
                    let viewContractBtn = `<button class="btn btn-link" style="padding:6px 12px; font-size:0.8rem;" onclick="viewSignedContract(${b.id}, '${b.tutor_name}', '${b.lesson_time}', '${b.price}', '${cType}')"><i class="fas fa-file-contract"></i> ÂçèËÆÆ</button>`;

                    // üè∑Ô∏è ÂΩ©Ëâ≤ËÉ∂ÂõäÁä∂ÊÄÅÊ†áÁ≠æ
                    if (b.status === 'ÂæÖÁ°ÆËÆ§') {
                        statusBadge = '<span class="status-badge status-pending"><i class="fas fa-hourglass-half"></i> ÂæÖÁ°ÆËÆ§</span>';
                        btnHtml = '<span style="color:var(--text-muted); font-size:0.85rem;">Á≠âÂæÖËÄÅÂ∏àÁ°ÆËÆ§...</span>';
                    }
                    else if (b.status === 'Â∑≤ÈÄöËøá') {
                        statusBadge = '<span class="status-badge status-paid"><i class="fas fa-credit-card"></i> ÂæÖÊîØ‰ªò</span>';
                        btnHtml = `<button class="btn btn-gold" onclick="goToCheckout(${b.id}, ${b.price}, '${b.tutor_name}', '${b.lesson_time}', '${cType}')">
                                    <i class="fas fa-credit-card"></i> ÂéªÊîØ‰ªò ¬•${b.price}
                                   </button>`;
                    }
                    else if (b.status === 'Â∑≤ÊîØ‰ªò') {
                        statusBadge = '<span class="status-badge status-ongoing"><i class="fas fa-play-circle"></i> ÂæÖ‰∏äËØæ</span>';
                        // üîò ËÑâÂÜ≤Âä®ÁîªËøõÂÖ•ÊïôÂÆ§ÊåâÈíÆ
                        btnHtml = `
                            <div style="display:flex; gap:8px; justify-content:flex-end; align-items:center; flex-wrap:wrap;">
                                ${viewContractBtn}
                                <button class="btn btn-classroom" onclick="enterClassroom(${b.id}, 'student', '${encodeURIComponent(myName)}')">
                                    <i class="fas fa-video"></i> ËøõÂÖ•ÊïôÂÆ§
                                </button>
                                <button class="btn btn-danger" style="padding:8px 12px;" onclick="applyRefundModal(${b.id})">
                                    <i class="fas fa-undo"></i>
                                </button>
                            </div>`;
                    }
                    else if (b.status === 'ÈÄÄÊ¨æ‰∏≠') {
                        statusBadge = '<span class="status-badge status-refund"><i class="fas fa-sync-alt fa-spin"></i> ÈÄÄÊ¨æ‰∏≠</span>';
                        btnHtml = '<span style="color:var(--text-muted); font-size:0.85rem;">ÂÆ°Ê†∏‰∏≠ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ</span>';
                    }
                    else if (b.status === 'ÂæÖËØÑ‰ª∑') {
                        statusBadge = '<span class="status-badge status-review"><i class="fas fa-star"></i> ÂæÖËØÑ‰ª∑</span>';
                        btnHtml = `
                            <div style="display:flex; gap:8px;">
                                ${viewContractBtn}
                                <button class="btn btn-primary" onclick="openReview(${b.id})">
                                    <i class="fas fa-pen"></i> ÂéªËØÑ‰ª∑
                                </button>
                            </div>`;
                    }
                    else if (b.status === 'Â∑≤ÂÆåÊàê') {
                        statusBadge = '<span class="status-badge status-completed"><i class="fas fa-check"></i> Â∑≤ÂÆåÊàê</span>';
                        btnHtml = viewContractBtn;
                    }
                    else if (b.status === 'Â∑≤ÊãíÁªù') {
                        statusBadge = '<span class="status-badge status-refund"><i class="fas fa-times"></i> Â∑≤ÊãíÁªù</span>';
                    }
                    
                    // ÊéàËØæÊñπÂºèÊ†áÁ≠æ
                    let typeIcon = cType === 'Á∫ø‰∏ã‰∏äÈó®' 
                        ? `<span style="display:inline-flex; align-items:center; gap:4px; font-size:0.75rem; color:#F87171; background:rgba(239,68,68,0.1); padding:3px 8px; border-radius:6px;"><i class="fas fa-home"></i> Á∫ø‰∏ã</span>`
                        : `<span style="display:inline-flex; align-items:center; gap:4px; font-size:0.75rem; color:#60A5FA; background:rgba(59,130,246,0.1); padding:3px 8px; border-radius:6px;"><i class="fas fa-laptop"></i> Á∫ø‰∏ä</span>`;

                    h += `<div class="list-item" style="animation-delay:${index * 0.05}s;">
                            <div style="flex:1;">
                                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px; flex-wrap:wrap;">
                                    <span style="font-weight:700; font-size:1.05rem;">${b.tutor_name} ËÄÅÂ∏à</span>
                                    ${typeIcon}
                                </div>
                                <div style="display:flex; align-items:center; gap:12px; color:var(--text-muted); font-size:0.85rem;">
                                    <span><i class="far fa-calendar"></i> ${b.lesson_time}</span>
                                    <span><i class="fas fa-yen-sign"></i> ${b.price}</span>
                                </div>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:10px;">
                                ${statusBadge}
                                ${btnHtml}
                            </div>
                          </div>`;
                });
            }
            document.getElementById('courseList').innerHTML = h;
        }

        function enterClassroom(orderId, role, encodedName) {
            window.open(`classroom.html?room=${orderId}&role=${role}&name=${encodedName}`, '_blank');
        }

        function applyRefundModal(id) {
            currentRefundId = id;
            document.getElementById('refundReason').value = "ËÄÅÂ∏àÊú™ÊåâÊó∂‰∏äËØæ";
            document.getElementById('refundDesc').value = "";
            document.getElementById('refundModal').style.display = 'flex';
        }

        function doRefundSubmit() {
            let reason = document.getElementById('refundReason').value;
            let desc = document.getElementById('refundDesc').value;
            if(!desc) { alert('ËØ∑Â°´ÂÜôËØ¶ÁªÜËØ¥Êòé'); return; }
            
            showLoading();
            let fd = new FormData();
            fd.append('id', currentRefundId);
            fd.append('phone', phone);
            fd.append('reason', reason + ": " + desc);
            
            fetch('api/user_api.php?action=apply_refund', {method:'POST', body:fd})
            .then(r=>r.json())
            .then(d => {
                hideLoading();
                if(d.status === 'success') {
                    document.getElementById('refundModal').style.display = 'none';
                    alert('‚úÖ Áî≥ËØ∑Êèê‰∫§ÊàêÂäüÔºåËØ∑Á≠âÂæÖÂπ≥Âè∞ÂÆ°Ê†∏');
                    loadCourses();
                } else {
                    alert('Êèê‰∫§Â§±Ë¥•: ' + d.message);
                }
            });
        }

        // --- ‚ú® Êî∂Èì∂Âè∞ÈÄªËæëÂçáÁ∫ßÁâà (Âä®ÊÄÅÁîüÊàêÂçèËÆÆ) ---
        function generateContractHtml(id, tutorName, time, price, classType) {
            let studentName = document.getElementById('uNameDisplay').innerText;
            let today = new Date().toLocaleDateString();
            
            // Ê†πÊçÆ classType Âä®ÊÄÅÂèòÂåñÊù°Ê¨æ
            let isOffline = (classType === 'Á∫ø‰∏ã‰∏äÈó®');
            let typeText = isOffline ? "Á∫ø‰∏ã‰∏äÈó® (Èù¢ÂØπÈù¢ÊéàËØæ)" : "Âú®Á∫øËßÜÈ¢ëÊïôÂ≠¶";
            
            // Â∑ÆÂºÇÂåñÊù°Ê¨æ
            let specificTerms = "";
            if(isOffline) {
                specificTerms = `
                    1. ‰πôÊñπ(ÊïôÂëò)Â∫îÊåâÊó∂Âà∞ËææÁ∫¶ÂÆöÂú∞ÁÇπÊéàËØæÔºåÂæÄËøîÈÄî‰∏≠Ê≥®ÊÑè‰∫§ÈÄöÂÆâÂÖ®„ÄÇ<br>
                    2. Áî≤Êñπ(Â≠¶Âëò)Â∫îÊèê‰æõÂÆâÂÖ®„ÄÅÂÆâÈùô„ÄÅÊ≠£ËßÑÁöÑÊïôÂ≠¶Âú∫ÊâÄ„ÄÇ<br>
                    3. Â¶ÇÈúÄÂèñÊ∂àËØæÁ®ãÔºåÂèåÊñπÈúÄÊèêÂâç24Â∞èÊó∂ÂçèÂïÜÔºåÂê¶ÂàôÈúÄÊâøÊãÖÁõ∏Â∫îÁöÑÁ©∫Ë∑ëË¥πÊàñËøùÁ∫¶Èáë„ÄÇ<br>
                    4. ‰∏ôÊñπÂπ≥Âè∞‰ªÖÊèê‰æõ‰ø°ÊÅØÊíÆÂêà‰∏éËµÑÈáëÊâòÁÆ°Ôºå‰∏çÊâøÊãÖÁ∫ø‰∏ã‰∏çÂèØÊäóÂäõÈ£éÈô©„ÄÇ
                `;
            } else {
                specificTerms = `
                    1. ÂèåÊñπÂ∫îÁ°Æ‰øùÁΩëÁªúÁéØÂ¢ÉÁïÖÈÄöÔºåÊèêÂâçË∞ÉËØïÂ•ΩËÆæÂ§á„ÄÇ<br>
                    2. ÊéàËØæËøáÁ®ã‰∏≠ÔºåÊú™ÁªèÂØπÊñπÂÖÅËÆ∏Ôºå‰∏çÂæóÁßÅËá™ÂΩïÂà∂„ÄÅ‰º†Êí≠ËØæÁ®ãËßÜÈ¢ë„ÄÇ<br>
                    3. Â¶ÇÂõ†ÁΩëÁªúÊïÖÈöúÂØºËá¥Êó†Ê≥ï‰∏äËØæÔºåÂèåÊñπÂ∫îÂèãÂ•ΩÂçèÂïÜË°•ËØæÊó∂Èó¥„ÄÇ
                `;
            }

            return `
                <div class="contract-title">Êô∫ÊÖßÂÆ∂ÊïôÊ°•ËØæÁ®ãÊúçÂä°ÂçèËÆÆ (${isOffline ? 'Á∫ø‰∏ãÁâà' : 'Á∫ø‰∏äÁâà'})</div>
                <div class="contract-section">
                    <span class="contract-bold">ÂçèËÆÆÁºñÂè∑Ôºö</span> AGR-${new Date().getFullYear()}-${id.toString().padStart(6,'0')}<br>
                    <span class="contract-bold">Êó•ÊúüÔºö</span> ${today}
                </div>
                <div class="contract-section">
                    <span class="contract-bold">Áî≤ÊñπÔºàÂ≠¶ÁîüÔºâÔºö</span> ${studentName}<br>
                    <span class="contract-bold">‰πôÊñπÔºàÊïôÂëòÔºâÔºö</span> ${tutorName}<br>
                    <span class="contract-bold">‰∏ôÊñπÔºàÂπ≥Âè∞ÔºâÔºö</span> Êô∫ÊÖßÂÆ∂ÊïôÊ°•Âπ≥Âè∞
                </div>
                <div class="contract-section">
                    <p>Èâ¥‰∫éÁî≤ÊñπÂ∏åÊúõÈÄöËøá‰∏ôÊñπÂπ≥Âè∞Ëé∑Âèñ‰πôÊñπÁöÑÂÆ∂ÊïôÊúçÂä°Ôºå‰∏âÊñπÁªèÂèãÂ•ΩÂçèÂïÜÔºåËææÊàêÂ¶Ç‰∏ãÂçèËÆÆÔºö</p>
                </div>
                <div class="contract-section">
                    <span class="contract-bold">Á¨¨‰∏ÄÊù° ÊúçÂä°ÂÜÖÂÆπ</span><br>
                    1. ‰πôÊñπÂ∞ÜÊåâÁÖß‰ª•‰∏ãÁ∫¶ÂÆöÊèê‰æõÂÆ∂ÊïôÊúçÂä°Ôºö<br>
                    &nbsp;&nbsp;&nbsp; - ÊéàËØæÊó∂Èó¥Ôºö${time}<br>
                    &nbsp;&nbsp;&nbsp; - ÊéàËØæÊñπÂºèÔºö<span style="font-weight:bold; color:${isOffline?'#d93025':'#6366F1'}">${typeText}</span><br>
                    &nbsp;&nbsp;&nbsp; - ÊúçÂä°Ë¥πÁî®Ôºö‰∫∫Ê∞ëÂ∏Å ${price} ÂÖÉ
                </div>
                <div class="contract-section">
                    <span class="contract-bold">Á¨¨‰∫åÊù° ÊùÉÂà©‰πâÂä°‰∏éÁâπÂà´Á∫¶ÂÆö</span><br>
                    ${specificTerms}
                </div>
                <div class="contract-section">
                    <span class="contract-bold">Á¨¨‰∏âÊù° ËµÑÈáëÁªìÁÆó</span><br>
                    1. Áî≤ÊñπÊîØ‰ªòÂêéËµÑÈáëÁî±Âπ≥Âè∞ÊâòÁÆ°„ÄÇËØæÁ®ãÁªìÊùü‰∏îÊó†ÂºÇËÆÆÂêéÔºåËµÑÈáëÁªìÁÆóÁªô‰πôÊñπ„ÄÇ
                </div>
                <div style="margin-top:30px; border-top:1px dashed #ccc; padding-top:10px;">
                    <div style="display:flex; justify-content:space-between;">
                        <div>Áî≤ÊñπÁ≠æÂ≠óÔºö<u>${studentName}</u></div>
                        <div>‰πôÊñπÁ≠æÂ≠óÔºö<u>${tutorName}</u></div>
                    </div>
                </div>
            `;
        }

        function goToCheckout(id, price, tutorName, lessonTime, classType) {
            checkoutData = { id, price, tutorName, lessonTime, classType };
            
            // Â°´ÂÖÖÂè≥‰æßÊï∞ÊçÆ
            document.getElementById('coTutor').innerText = tutorName;
            document.getElementById('coTime').innerText = lessonTime;
            document.getElementById('coOriginal').innerText = '¬• ' + parseFloat(price).toFixed(2);
            document.getElementById('coClassType').innerText = classType || 'Á∫ø‰∏äÊïôÂ≠¶';
            
            // ÁîüÊàêÂ∑¶‰æßÂçèËÆÆHTML
            document.getElementById('checkoutContractContent').innerHTML = generateContractHtml(id, tutorName, lessonTime, price, classType);
            
            // --- Ê†∏ÂøÉ‰øÆÊîπÔºöÈáçÁΩÆÁ≠æÁΩ≤Áä∂ÊÄÅ ---
            isCurrentContractSigned = false;
            
            // 1. ÊòæÁ§∫Á≠æÁΩ≤ÊåâÈíÆÔºåÈöêËóèÂ∑≤Á≠æÁΩ≤Áä∂ÊÄÅ
            document.getElementById('signActionArea').style.display = 'block';
            document.getElementById('signedDisplayArea').style.display = 'none';
            
            // 2. ÈöêËóèÂç∞Á´†
            document.getElementById('contractStamp').classList.remove('show');
            
            // 3. ÈîÅÂÆöÊîØ‰ªòÊåâÈíÆ
            const payBtn = document.getElementById('btn-final-pay');
            payBtn.disabled = true;
            payBtn.style.opacity = '0.5';
            payBtn.style.cursor = 'not-allowed';
            payBtn.style.filter = 'grayscale(1)';
            payBtn.innerText = 'üîí ËØ∑ÂÖàÂú®Â∑¶‰æßÁ≠æÁΩ≤ÂçèËÆÆ';

            // Âä†ËΩΩ‰ºòÊÉ†Âà∏
            const sel = document.getElementById('coCouponSelect');
            sel.innerHTML = '<option value="">‰∏ç‰ΩøÁî®‰ºòÊÉ†Âà∏</option>';
            myCoupons.forEach(c => {
                if(price >= parseFloat(c.min_spend)) {
                    let opt = document.createElement('option');
                    opt.value = c.cid;
                    opt.text = `${c.name} (ÁúÅ¬•${c.discount})`;
                    opt.dataset.discount = c.discount;
                    sel.add(opt);
                }
            });
            calcCheckoutPrice();
            
            switchView('checkout');
        }

        // --- Êñ∞Â¢ûÔºöÁ≠æÁΩ≤ÂçèËÆÆÂä®Áîª‰∏éÈÄªËæë ---
        function signContract() {
            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÂêçÔºåÁî®‰∫éÁîüÊàêÊâãÂÜôÁ≠æÂêç
            const myName = document.getElementById('uNameDisplay').innerText || "Â≠¶Áîü";
            
            // 1. ÈöêËóèÁ≠æÁΩ≤ÊåâÈíÆÔºåÊòæÁ§∫Á≠æÂêçÁªìÊûú
            document.getElementById('signActionArea').style.display = 'none';
            document.getElementById('signedDisplayArea').style.display = 'block';
            
            // 2. Â°´ÂÖÖÁ≠æÂêç‰ø°ÊÅØ
            document.getElementById('myHandSignature').innerText = myName;
            document.getElementById('signedTime').innerText = new Date().toLocaleString();
            
            // 3. ÁõñÁ´†Âä®Áîª
            setTimeout(() => {
                document.getElementById('contractStamp').classList.add('show');
            }, 100);

            // 4. Ëß£ÈîÅÊîØ‰ªòÊåâÈíÆ
            isCurrentContractSigned = true;
            updatePayButtonState(); // Êõ¥Êñ∞ÊåâÈíÆÊñáÂ≠óÂíåÁä∂ÊÄÅ
        }

        function updatePayButtonState() {
            const payBtn = document.getElementById('btn-final-pay');
            const finalPrice = document.getElementById('coFinal').innerText;
            
            if (isCurrentContractSigned) {
                payBtn.disabled = false;
                payBtn.style.opacity = '1';
                payBtn.style.cursor = 'pointer';
                payBtn.style.filter = 'none';
                payBtn.innerHTML = `<i class="fas fa-lock-open"></i> Á´ãÂç≥ÊîØ‰ªò ¬•${finalPrice}`;
                payBtn.classList.add('btn-signin'); // ËÑâÂÜ≤Âä®ÁîªÊèêÁ§∫
            } else {
                payBtn.disabled = true;
                payBtn.innerText = 'üîí ËØ∑ÂÖàÂú®Â∑¶‰æßÁ≠æÁΩ≤ÂçèËÆÆ';
                payBtn.classList.remove('btn-signin');
            }
        }

        function calcCheckoutPrice() {
            const sel = document.getElementById('coCouponSelect');
            let discount = 0;
            if(sel.value) { discount = parseFloat(sel.options[sel.selectedIndex].dataset.discount); }
            let final = checkoutData.price - discount;
            if(final < 0) final = 0;
            document.getElementById('coFinal').innerText = final.toFixed(2);
            
            // Â¶ÇÊûúÂ∑≤ÁªèÁ≠æÁΩ≤‰∫ÜÔºåÈáçÊñ∞ËÆ°ÁÆóÂêéË¶ÅÊõ¥Êñ∞ÊåâÈíÆ‰∏äÁöÑÈáëÈ¢ùÊï∞Â≠ó
            if(isCurrentContractSigned) {
                updatePayButtonState();
            }
        }

        function confirmCheckout() {
            // ÂèåÈáçÊ£ÄÊü•
            if(!isCurrentContractSigned) {
                alert("ËØ∑ÂÖàÈòÖËØªÂπ∂Á≠æÁΩ≤Â∑¶‰æßÁöÑÊúçÂä°ÂçèËÆÆÔºÅ");
                return;
            }
            
            let couponId = document.getElementById('coCouponSelect').value;
            let finalAmount = document.getElementById('coFinal').innerText;

            if(!confirm(`Á°ÆËÆ§ÊîØ‰ªò ¬•${finalAmount} Âπ∂Êèê‰∫§ËÆ¢Âçï?`)) return;

            showLoading(); 
            let fd = new FormData();
            fd.append('id', checkoutData.id);
            fd.append('phone', phone);
            fd.append('amount', finalAmount);
            if(couponId) fd.append('coupon_id', couponId);

            fetch('api/user_api.php?action=pay_order', {method:'POST', body:fd})
            .then(r=>r.json())
            .then(d => {
                hideLoading();
                if(d.status === 'success') {
                    document.getElementById('successAmount').innerText = finalAmount;
                    document.getElementById('paySuccessModal').style.display = 'flex';
                    loadInfo(); loadCourses(); loadBills(); loadCoupons();
                } else {
                    alert('‚ùå ÊîØ‰ªòÂ§±Ë¥•: ' + d.message);
                }
            });
        }
        
        function goToWaitClass() {
            document.getElementById('paySuccessModal').style.display = 'none';
            switchView('courses');
            setTimeout(() => document.getElementById('tab-wait').click(), 500);
        }

        function viewSignedContract(id, tutorName, time, price, classType) {
            document.getElementById('viewContractContent').innerHTML = generateContractHtml(id, tutorName, time, price, classType);
            document.getElementById('contractViewModal').style.display = 'flex';
        }

        // ================ üéÜ ÁÉüËä±Âä®ÁîªÊïàÊûú ================
        function createConfetti() {
            let container = document.getElementById('confetti-container');
            if (!container) {
                const confettiDiv = document.createElement('div');
                confettiDiv.id = 'confetti-container';
                document.body.appendChild(confettiDiv);
                container = confettiDiv;
            }
            
            const colors = ['#F59E0B', '#FCD34D', '#10B981', '#3B82F6', '#A855F7', '#EF4444'];
            const pieces = 50;
            
            for (let i = 0; i < pieces; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        // ================ üèÜ Âä†ËΩΩÊàêÂ∞±Â¢ô ================
        function loadAchievements() {
            fetch(`api/gamification_api.php?action=get_badges&phone=${phone}&role=student`)
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success') {
                        const badges = res.badges || [];
                        document.getElementById('unlockedCount').innerText = res.unlocked_count || 0;
                        document.getElementById('totalBadges').innerText = badges.length;
                        
                        let html = '';
                        badges.forEach(badge => {
                            html += `
                                <div class="achievement-card ${badge.unlocked ? 'unlocked' : 'locked'}">
                                    ${!badge.unlocked ? '<i class="fas fa-lock achievement-lock"></i>' : ''}
                                    <span class="achievement-icon">${badge.icon}</span>
                                    <div class="achievement-name">${badge.name}</div>
                                    <div class="achievement-desc">${badge.desc}</div>
                                </div>
                            `;
                        });
                        document.getElementById('achievementGrid').innerHTML = html || '<p style="grid-column:1/-1; text-align:center; color:var(--text-gray);">ÊöÇÊó†ÊàêÂ∞±Êï∞ÊçÆ</p>';
                    }
                })
                .catch(err => console.error('Âä†ËΩΩÊàêÂ∞±Â§±Ë¥•:', err));
        }
        
        // ================ ‚≠ê Âä†ËΩΩÁßØÂàÜ‰∏≠ÂøÉ ================
        function loadPointsCenter() {
            // Âä†ËΩΩÁ≠âÁ∫ß‰ø°ÊÅØ
            fetch(`api/gamification_api.php?action=get_level_info&phone=${phone}`)
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success' && res.data) {
                        const data = res.data;
                        document.getElementById('levelName').innerText = data.level_name || 'ÈùíÈìúÂ≠¶Âëò';
                        document.getElementById('levelNumber').innerText = `LV.${data.level || 1}`;
                        document.getElementById('currentPoints').innerText = data.points || 0;
                        const needed = (data.next_level_points || 500) - (data.points || 0);
                        document.getElementById('neededPoints').innerText = needed > 0 ? needed : 0;
                        
                        // ËÆ°ÁÆóËøõÂ∫¶ÁôæÂàÜÊØî
                        const current = data.points || 0;
                        const next = data.next_level_points || 500;
                        const prev = current >= 500 ? (data.level >= 2 ? 500 : 0) : 0;
                        const progressPercent = next > prev ? ((current - prev) / (next - prev) * 100) : 0;
                        const safePercent = Math.max(0, Math.min(100, progressPercent));
                        
                        document.getElementById('progressPercent').innerText = safePercent.toFixed(0) + '%';
                        document.getElementById('progressBar').style.width = safePercent + '%';
                    }
                })
                .catch(err => {
                    console.error('Âä†ËΩΩÁ≠âÁ∫ß‰ø°ÊÅØÂ§±Ë¥•:', err);
                });
            
            // Âä†ËΩΩÁ≠æÂà∞Áä∂ÊÄÅ
            fetch(`api/gamification_api.php?action=get_status&phone=${phone}`)
                .then(r => r.json())
                .then(res => {
                    const btn = document.getElementById('centerSigninBtn');
                    if (res.status === 'success' && res.data) {
                        if (res.data.is_signed) {
                            btn.innerHTML = '<i class="fas fa-check"></i> ‰ªäÊó•Â∑≤Á≠æÂà∞';
                            btn.classList.add('disabled');
                            btn.removeAttribute('onclick');
                        }
                    }
                })
                .catch(err => {
                    console.error('Âä†ËΩΩÁ≠æÂà∞Áä∂ÊÄÅÂ§±Ë¥•:', err);
                });
            
            // Âä†ËΩΩÂïÜÂüéÂïÜÂìÅ
            fetch(`api/gamification_api.php?action=get_mall_items`)
                .then(r => r.json())
                .then(res => {
                    let h = '';
                    if (res.status === 'success' && res.data && res.data.length > 0) {
                        res.data.forEach(item => {
                            h += `
                                <div class="mall-item">
                                    <div class="coin-icon"><i class="fas fa-ticket-alt"></i></div>
                                    <div style="font-weight:bold;margin-bottom:5px;">${item.name}</div>
                                    <div style="color:var(--gold);font-weight:bold;margin-bottom:15px;">${item.points_cost} ÁßØÂàÜ</div>
                                    <button class="btn btn-primary" style="font-size:0.8rem;padding:5px 15px;" onclick="exchangeItem(${item.id}, ${item.points_cost})">Á´ãÂç≥ÂÖëÊç¢</button>
                                </div>
                            `;
                        });
                    } else {
                        h = '<p style="grid-column:1/-1;text-align:center;color:gray">ÊöÇÊó†ÂïÜÂìÅ</p>';
                    }
                    document.getElementById('pointsMallList').innerHTML = h;
                })
                .catch(err => {
                    console.error('Âä†ËΩΩÂïÜÂüéÂïÜÂìÅÂ§±Ë¥•:', err);
                    document.getElementById('pointsMallList').innerHTML = '<p style="grid-column:1/-1;text-align:center;color:gray">Âä†ËΩΩÂ§±Ë¥•</p>';
                });
        }
        
        // ================ üí∞ Âä†ËΩΩÈí±ÂåÖÂíåÁßØÂàÜÊï∞ÊçÆ ================
        function loadWalletAndPoints() {
            // Âä†ËΩΩ‰ΩôÈ¢ù
            fetch(`api/user_api.php?action=get_info&phone=${phone}`)
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success' && res.data) {
                        const balance = parseFloat(res.data.balance || 0).toFixed(2);
                        document.getElementById('uBalance').innerText = balance;
                        const uBalanceBig = document.getElementById('uBalanceBig');
                        if (uBalanceBig) uBalanceBig.innerText = balance;
                    }
                })
                .catch(err => console.error('Âä†ËΩΩ‰ΩôÈ¢ùÂ§±Ë¥•:', err));
            
            // Âä†ËΩΩÁßØÂàÜ
            fetch(`api/gamification_api.php?action=get_status&phone=${phone}`)
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success' && res.data) {
                        const points = res.data.points || 0;
                        document.getElementById('uPoints').innerText = points;
                        const uPointsBig = document.getElementById('uPointsBig');
                        if (uPointsBig) uPointsBig.innerText = points;
                    }
                })
                .catch(err => console.error('Âä†ËΩΩÁßØÂàÜÂ§±Ë¥•:', err));
        }
        
        // ================ üéÜ Â∏¶ÁÉüËä±ÊïàÊûúÁöÑÁ≠æÂà∞ ================
        function doSigninWithConfetti() {
            fetch(`api/gamification_api.php?action=do_signin`, {
                method: 'POST',
                body: new URLSearchParams({phone: phone})
            })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    createConfetti();
                    setTimeout(() => {
                        alert('üéâ ' + d.message);
                        loadPointsData();
                        loadPointsCenter();
                        loadAchievements();
                    }, 500);
                } else {
                    alert(d.message);
                }
            });
        }
        
        // --- ÂéüÊúâÈÄªËæë‰øùÊåÅ‰∏çÂèò ---
        function loadPointsData() {
            fetch(`api/gamification_api.php?action=get_status&phone=${phone}`)
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success' && res.data) {
                        const points = res.data.points || 0;
                        document.getElementById('uPoints').innerText = points;
                        document.getElementById('uPointsBig').innerText = points;
                        const btn = document.getElementById('signinBtn');
                        if (btn) {
                            if (res.data.is_signed) {
                                btn.innerHTML = '<i class="fas fa-check"></i> ‰ªäÊó•Â∑≤Á≠æ';
                                btn.classList.add('disabled');
                                btn.removeAttribute('onclick');
                            } else {
                                btn.setAttribute('onclick', 'doSigninWithConfetti()');
                            }
                        }
                    }
                })
                .catch(err => console.error('Âä†ËΩΩÁßØÂàÜÁä∂ÊÄÅÂ§±Ë¥•:', err));
            
            fetch(`api/gamification_api.php?action=get_mall_items`)
                .then(r => r.json())
                .then(res => {
                    let h = '';
                    if (res.status === 'success' && res.data && res.data.length > 0) {
                        res.data.forEach(item => {
                            h += `<div class="mall-item"><div class="coin-icon"><i class="fas fa-ticket-alt"></i></div><div style="font-weight:bold;margin-bottom:5px;">${item.name}</div><div style="color:var(--gold);font-weight:bold;margin-bottom:15px;">${item.points_cost} ÁßØÂàÜ</div><button class="btn btn-primary" style="font-size:0.8rem;padding:5px 15px;" onclick="exchangeItem(${item.id}, ${item.points_cost})">Á´ãÂç≥ÂÖëÊç¢</button></div>`;
                        });
                    } else {
                        h = '<p style="grid-column:1/-1;text-align:center;color:gray">ÊöÇÊó†ÂïÜÂìÅ</p>';
                    }
                    const mallList = document.getElementById('mallList');
                    if (mallList) mallList.innerHTML = h;
                })
                .catch(err => console.error('Âä†ËΩΩÂïÜÂüéÂïÜÂìÅÂ§±Ë¥•:', err));
        }
        function exchangeItem(id,cost){let cur=parseInt(document.getElementById('uPoints').innerText);if(cur<cost)return alert('ÁßØÂàÜ‰∏çË∂≥');if(!confirm(`Ê∂àËÄó ${cost} ÁßØÂàÜÂÖëÊç¢Ôºü`))return;let fd=new FormData();fd.append('phone',phone);fd.append('coupon_id',id);fetch(`api/gamification_api.php?action=exchange_item`,{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert('ÂÖëÊç¢ÊàêÂäü');loadPointsData();loadCoupons();}else alert(d.message);});}
        function postDemand(){let s=document.getElementById('dmSubject').value;let g=document.getElementById('dmGrade').value;let b=document.getElementById('dmBudget').value;let r=document.getElementById('dmReq').value;if(!s||!g||!b)return alert('ËØ∑Â°´ÂÜôÂÆåÊï¥');let fd=new FormData();fd.append('phone',phone);fd.append('subject',s);fd.append('grade',g);fd.append('budget',b);fd.append('requirement',r);fetch('api/demand_api.php?action=post_demand',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert('ÂèëÂ∏ÉÊàêÂäü');document.getElementById('demandModal').style.display='none';loadDemands();}else alert(d.message);});}
        function loadDemands(){fetch(`api/demand_api.php?action=get_my_demands&phone=${phone}`).then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<p style=\"text-align:center;padding:30px;color:gray\">ÊöÇÊó†ÈúÄÊ±Ç</p>';else res.data.forEach(d=>{let status=d.status==='open'?'<span class=\"badge\" style=\"background:#10B981\">ÊãõËÅò‰∏≠</span>':'<span class=\"badge\" style=\"background:#64748B\">Â∑≤ÁªìÊùü</span>';let btn=d.status==='open'?`<button class=\"btn btn-primary\" style=\"font-size:0.8rem;\" onclick=\"showAppliers(${d.id})\">Êü•ÁúãÂ∫îËÅò (${d.apply_count})</button>`:'';h+=`<div class=\"list-item\"><div><div style=\"font-weight:bold;margin-bottom:5px;\">${d.subject} (${d.grade})</div><div style=\"color:#94A3B8;font-size:0.85rem;\">È¢ÑÁÆó: ¬•${d.budget}/h ¬∑ ${d.create_time}</div></div><div style=\"text-align:right;display:flex;gap:10px;align-items:center;\">${status} ${btn}</div></div>`;});document.getElementById('demandList').innerHTML=h;});}
        function showAppliers(did){fetch(`api/demand_api.php?action=get_appliers&demand_id=${did}`).then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<p style=\"text-align:center;padding:20px;color:gray\">ÊöÇÊó†Â∫îËÅò</p>';else res.data.forEach(t=>{let avatar=t.avatar||'default_boy.png';if(!avatar.includes('/'))avatar='assets/'+avatar;h+=`<div class=\"list-item\"><div style=\"display:flex;align-items:center;gap:10px;\"><img src=\"${avatar}\" style=\"width:40px;height:40px;border-radius:50%;object-fit:cover;\"><div><div style=\"font-weight:bold\">${t.name}</div><div style=\"font-size:0.8rem;color:gray\">${t.school}</div></div></div><div><button class=\"btn btn-primary\" style=\"padding:6px 12px;font-size:0.8rem;margin-right:5px;\" onclick=\"window.open('detail.html?id=${t.tutor_id}', '_blank')\">Êü•ÁúãËµÑÊñô</button><button class=\"btn btn-success\" style=\"padding:6px 12px;font-size:0.8rem;\" onclick=\"acceptTutor(${t.id})\">ÂΩïÁî®</button></div></div>`;});document.getElementById('applyList').innerHTML=h;document.getElementById('applyModal').style.display='flex';});}
        function acceptTutor(aid){if(!confirm('Á°ÆËÆ§ÂΩïÁî®Ôºü'))return;let fd=new FormData();fd.append('apply_id',aid);fetch('api/demand_api.php?action=accept_tutor',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert('üéâ ÂΩïÁî®ÊàêÂäüÔºÅ');location.reload();}else alert(d.message);});}
        function loadMyResources(){fetch(`api/user_api.php?action=get_my_downloads&phone=${phone}`).then(r=>r.json()).then(res=>{let h='';if(!res.data||res.data.length===0)h='<div style=\"text-align:center;padding:50px;color:gray\"><i class=\"fas fa-folder-open\" style=\"font-size:3rem;margin-bottom:20px;opacity:0.5\"></i><br>ÊöÇÊó†ËµÑÊñô<br><a href="resources.html" style="color:var(--primary)">ÂéªÂïÜÂüéÈÄõÈÄõ</a></div>';else res.data.forEach(r=>{h+=`<div class=\"list-item\" style=\"align-items:center;\"><div style=\"display:flex;gap:15px;align-items:center;\"><div style=\"width:50px;height:50px;background:rgba(99,102,241,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center;\"><i class=\"fas fa-file-alt\" style=\"font-size:1.5rem;color:var(--primary)\"></i></div><div><div style=\"font-weight:bold;font-size:1.1rem;margin-bottom:5px;\">${r.title}</div><div style=\"color:var(--text-gray);font-size:0.8rem;\">${r.type} ¬∑ Ë¥≠‰π∞Êó∂Èó¥: ${r.buy_time}</div></div></div><button class=\"btn btn-primary\" onclick=\"downloadRes(${r.id})\"><i class=\"fas fa-download\"></i> ‰∏ãËΩΩ</button></div>`;});document.getElementById('myResList').innerHTML=h;});}
        function downloadRes(id){fetch(`api/resource_api.php?action=get_download_url&id=${id}`).then(r=>r.json()).then(d=>{if(d.status==='success')window.open(d.url,'_blank');else alert(d.message);});}
        function checkNotifs(){
            fetch(`api/user_api.php?action=check_unread&phone=${phone}`)
                .then(r => r.json())
                .then(d => {
                    const count = (d.status === 'success' && d.count) ? d.count : 0;
                    if (count > 0) {
                        const navDot = document.getElementById('navDot');
                        if (navDot) navDot.style.display = 'inline-block';
                    }
                })
                .catch(err => console.error('Ê£ÄÊü•Êú™ËØªÈÄöÁü•Â§±Ë¥•:', err));
        }
        function loadNotifs(){fetch(`api/user_api.php?action=get_notifications&phone=${phone}`).then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<p style=\"text-align:center;color:gray;padding:20px;\">ÊöÇÊó†Êñ∞ÈÄöÁü•</p>';else res.data.forEach(n=>{let safeContent=encodeURIComponent(n.content);let title=n.content.includes('ÂÖ¨Âëä')?'Á≥ªÁªüÂÖ¨Âëä':'ÈÄöÁü•Ê∂àÊÅØ';h+=`<div class=\"list-item\" onclick=\"showMsgDetail('${title}','${safeContent}')\" style=\"justify-content:flex-start;gap:15px;cursor:pointer;\"><div style=\"color:var(--primary);font-size:1.5rem;"><i class=\"fas fa-bell\"></i></div><div style=\"flex:1;overflow:hidden;\"><div style=\"font-size:1rem;margin-bottom:5px;\">${title} <span style=\"font-size:0.8rem;color:gray;margin-left:10px;font-weight:normal\">${n.create_time}</span></div><div style=\"font-size:0.8rem;color:#94A3B8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;\">${n.content}</div></div><div><i class=\"fas fa-chevron-right\" style=\"color:gray;font-size:0.8rem\"></i></div></div>`;});document.getElementById('notifList').innerHTML=h;});}
        function showMsgDetail(title,contentEncoded){document.getElementById('msgDetailTitle').innerText=title;document.getElementById('msgDetailContent').innerText=decodeURIComponent(contentEncoded);document.getElementById('msgDetailModal').style.display='flex';}
        function loadContacts(){fetch(`api/chat_api.php?action=get_contacts&role=student&phone=${phone}`).then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<div style=\"padding:20px;text-align:center;\">ÊöÇÊó†ËÅîÁ≥ª‰∫∫</div>';else{res.data.forEach(c=>{let avatar=c.avatar||'default_boy.png';if(!avatar.includes('/'))avatar='assets/'+avatar;h+=`<div class=\"chat-item\" onclick=\"startChat('${c.phone}','${c.name}')\"><img src=\"${avatar}\" style=\"width:40px;height:40px;border-radius:50%;object-fit:cover;\"><div><div style=\"font-weight:bold\">${c.name}</div><div style=\"font-size:0.8rem;color:gray\">${c.school}</div></div></div>`;});}document.getElementById('contactList').innerHTML=h;});}
        function startChat(targetPhone,name){currentChatTarget=targetPhone;document.getElementById('chatHeader').innerText=`‰∏é ${name} ËÅäÂ§©‰∏≠`;loadHistory();if(chatInterval)clearInterval(chatInterval);chatInterval=setInterval(loadHistory,3000);}
        function loadHistory(){
            if (!currentChatTarget) return;
            fetch(`api/chat_api.php?action=get_history&me=${phone}&other=${currentChatTarget}`)
                .then(r => r.json())
                .then(res => {
                    let h = '';
                    if (res.status === 'success' && res.data && res.data.length > 0) {
                        res.data.forEach(m => {
                            let isMe = m.sender_phone === phone;
                            h += `<div class="msg-bubble ${isMe ? 'msg-right' : 'msg-left'}">${m.content}</div>`;
                        });
                    }
                    document.getElementById('chatMsgs').innerHTML = h;
                    let div = document.getElementById('chatMsgs');
                    if (div) div.scrollTop = div.scrollHeight;
                })
                .catch(err => console.error('Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', err));
        }
        function sendMsg(){
            let txt = document.getElementById('msgInput').value;
            if (!txt || !currentChatTarget) return;
            let fd = new FormData();
            fd.append('sender_phone', phone);
            fd.append('receiver_phone', currentChatTarget);
            fd.append('content', txt);
            fetch('api/chat_api.php?action=send_message', {method:'POST', body:fd})
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'success') {
                        document.getElementById('msgInput').value = '';
                        loadHistory();
                    } else {
                        alert(d.message || 'ÂèëÈÄÅÂ§±Ë¥•');
                    }
                })
                .catch(err => {
                    console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', err);
                    alert('ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                });
        }
        function loadInfo(){
            fetch(`api/user_api.php?action=get_info&phone=${phone}&_t=${Date.now()}`)
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'success' && d.data) {
                        const balance = parseFloat(d.data.balance || 0).toFixed(2);
                        document.getElementById('uBalance').innerText = balance;
                        const uBalanceBig = document.getElementById('uBalanceBig');
                        if (uBalanceBig) uBalanceBig.innerText = balance;
                        document.getElementById('uNameDisplay').innerText = d.data.username || 'ÂêåÂ≠¶';
                        const upName = document.getElementById('upName');
                        if (upName) upName.value = d.data.username || '';
                    }
                })
                .catch(err => console.error('Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', err));
        }
        function loadBills(){fetch(`api/user_api.php?action=get_wallet_history&phone=${phone}`).then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<p style=\"text-align:center;color:gray\">ÊöÇÊó†ËÆ∞ÂΩï</p>';else res.data.forEach(b=>{let isIn=b.amount.includes('+');h+=`<div class=\"list-item\"><div style=\"display:flex;align-items:center;gap:15px;\"><div style=\"width:40px;height:40px;border-radius:50%;background:${isIn?'rgba(16,185,129,0.2)':'rgba(239,68,68,0.2)'};display:flex;align-items:center;justify-content:center;color:${isIn?'#10B981':'#EF4444'}\"><i class=\"fas fa-${isIn?'arrow-down':'arrow-up'}\"></i></div><div><div style=\"font-weight:bold\">${b.title}</div><div style=\"font-size:0.8rem;color:#94A3B8\">${b.create_time}</div></div></div><div style=\"font-weight:bold;font-size:1.1rem;color:${isIn?'#10B981':'#EF4444'}\">${b.amount}</div></div>`;});document.getElementById('billList').innerHTML=h;});}
        function loadCourses(){fetch(`api/user_api.php?action=get_my_bookings&phone=${phone}&_t=${Date.now()}`).then(r=>r.json()).then(res=>{allBookings=res.data;const activeTab=document.querySelector('.tab-btn.active');if(activeTab)filterCourses(activeTab.id.replace('tab-',''),activeTab);else filterCourses('all',document.getElementById('tab-all'));});}
        function loadCoupons(){fetch(`api/user_api.php?action=get_my_coupons&phone=${phone}`).then(r=>r.json()).then(res=>{myCoupons=res.data;let h='';if(myCoupons.length===0)h='<p style=\"color:gray;font-size:0.9rem\">ÊöÇÊó†ÂèØÁî®‰ºòÊÉ†Âà∏</p>';else myCoupons.forEach(c=>{h+=`<div style=\"background:linear-gradient(135deg, #F59E0B, #D97706);padding:10px 15px;border-radius:8px;color:white;font-size:0.85rem;\"><div style=\"font-weight:bold;font-size:1.1rem\">¬•${c.discount}</div><div>Êª°${c.min_spend}ÂèØÁî®</div></div>`;});document.getElementById('couponList').innerHTML=h;});}
        function initCalendar(){var calendarEl=document.getElementById('calendar');calendar=new FullCalendar.Calendar(calendarEl,{initialView:'dayGridMonth',locale:'zh-cn',height:600,headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek'},events:`api/calendar_api.php?phone=${phone}&role=student`});}
        function recharge(){let n=prompt("ËØ∑ËæìÂÖ•ÂÖÖÂÄºÈáëÈ¢ù","1000");if(n&&parseFloat(n)>0){let fd=new FormData();fd.append('phone',phone);fd.append('amount',n);fetch('api/user_api.php?action=recharge',{method:'POST',body:fd}).then(()=>{alert('ÂÖÖÂÄºÊàêÂäü');loadInfo();loadBills();});} }
        function openReview(id){currentReviewId=id;document.getElementById('reviewModal').style.display='flex';}
        function submitReview(){let fd=new FormData();fd.append('booking_id',currentReviewId);fd.append('phone',phone);fd.append('rating',document.getElementById('ratingSelect').value);fd.append('content',document.getElementById('reviewContent').value);fetch('api/user_api.php?action=submit_review',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert('ËØÑ‰ª∑ÊàêÂäü');document.getElementById('reviewModal').style.display='none';loadCourses();}});}
        function saveProfile(){let fd=new FormData();fd.append('phone',phone);fd.append('username',document.getElementById('upName').value);fetch('api/user_api.php?action=update_profile',{method:'POST',body:fd}).then(()=>{alert('‰øùÂ≠òÊàêÂäü');loadInfo();});}
        function loadFavorites(){
            fetch(`api/user_api.php?action=get_my_favorites&phone=${phone}`)
                .then(r => r.json())
                .then(res => {
                    let h = '';
                    if (res.status === 'success' && res.data && res.data.length > 0) {
                        res.data.forEach(t => {
                            let avatar = t.avatar || 'default_boy.png';
                            if (!avatar.includes('/') && !avatar.startsWith('http')) {
                                avatar = 'assets/' + avatar;
                            }
                            h += `<div class="fav-card" onclick="location.href='detail.html?id=${t.tutor_id}'">
                                <img src="${avatar}" class="fav-avatar">
                                <div style="font-weight:bold;">${t.name || 'Êú™ÂëΩÂêç'}</div>
                                <div style="font-size:0.8rem;color:#94A3B8;margin-bottom:5px;">${t.school || ''}</div>
                                <div style="color:#FCD34D;">¬•${t.price || 0}/h</div>
                            </div>`;
                        });
                    } else {
                        h = '<p style="color:gray;">ÊöÇÊó†Êî∂Ëóè</p>';
                    }
                    const favList = document.getElementById('favList');
                    if (favList) favList.innerHTML = h;
                })
                .catch(err => console.error('Âä†ËΩΩÊî∂ËóèÂ§±Ë¥•:', err));
        }
    </script>
    
    <!-- üéÜ ÁÉüËä±Âä®ÁîªÂÆπÂô® -->
    <div id="confetti-container"></div>
</body>
</html>