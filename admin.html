<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0F4C81">
    
    <!-- Favicon & Icons -->
    <link rel="icon" type="image/x-icon" href="assets/icons/AppImages/ios/32.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/AppImages/ios/32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/AppImages/android/android-launchericon-192-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/AppImages/android/android-launchericon-512-512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/AppImages/ios/180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/icons/AppImages/ios/152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/icons/AppImages/ios/120.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <title>æ€»æ§å° | æ™ºæ…§å®¶æ•™æ¡¥</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* --- âœ¨ ç”µå½±çº§è§†è§‰æ•ˆæœç³»ç»Ÿ --- */
        :root { 
            --primary: #6366F1; 
            --primary-light: #818CF8;
            --accent: #F43F5E; 
            --accent-orange: #F59E0B;
            --success: #10B981;
            --bg-dark: #0F172A; 
            --bg-card: rgba(30, 41, 59, 0.8); 
            --text: #F8FAFC; 
            --text-gray: #94A3B8; 
            --border: rgba(255,255,255,0.12);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 30px rgba(99, 102, 241, 0.4);
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif; }
        body { 
            background: linear-gradient(135deg, #0F172A 0%, #1E1B4B 50%, #312E81 100%);
            background-attachment: fixed;
            color: var(--text); 
            height: 100vh; 
            display:flex; 
            overflow:hidden;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(244, 63, 94, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            z-index: -2;
            pointer-events: none;
            animation: gradientShift 20s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .sidebar { 
            width: 260px; 
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(25px) saturate(180%);
            border-right: 1.5px solid var(--border); 
            padding: 30px 20px; 
            display:flex; 
            flex-direction:column; 
            overflow-y: auto;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        .logo { 
            font-size: 1.4rem; 
            font-weight: 900; 
            margin-bottom: 50px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: transform 0.3s ease;
        }
        .logo img {
            height: 50px;
            width: auto;
            display: block;
        }
        .logo:hover { transform: scale(1.05); }
        .nav-item { 
            padding: 14px 18px; 
            margin-bottom: 6px; 
            cursor: pointer; 
            border-radius: 14px; 
            color: var(--text-gray); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; 
            align-items: center; 
            gap: 12px;
            position: relative;
            font-weight: 500;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 14px;
            background: linear-gradient(90deg, rgba(99,102,241,0.2), rgba(168,85,247,0.2));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .nav-item.active::before {
            opacity: 1;
        }
        .nav-item:hover { 
            background: rgba(255,255,255,0.05);
            transform: translateX(5px);
        }
        .nav-item.active { 
            color: var(--primary-light);
            border-left: 3px solid var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }
        .nav-item .badge {
            margin-left: auto;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .main { 
            flex: 1; 
            padding: 40px; 
            overflow-y: auto; 
            position: relative;
        }
        .main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at top right, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
                radial-gradient(circle at bottom left, rgba(244, 63, 94, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 35px;
            position: relative;
            z-index: 1;
        }
        .header h2 {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #FFFFFF, #E0E7FF);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }
        .view { 
            display: none; 
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }
        .view.active { display: block; }
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.98); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            } 
        }

        /* å¡ç‰‡ä¸è¡¨æ ¼ - ç”µå½±çº§å¢å¼º */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        .stat-card { 
            background: var(--bg-card);
            backdrop-filter: blur(20px) saturate(180%);
            padding: 28px; 
            border-radius: 20px; 
            border: 1.5px solid var(--border);
            position: relative; 
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 
                0 16px 48px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(99, 102, 241, 0.3),
                0 0 40px rgba(99, 102, 241, 0.2);
        }
        .stat-val { 
            font-size: 2.5rem; 
            font-weight: 900; 
            margin-top: 12px;
            background: linear-gradient(135deg, #FFFFFF, #E0E7FF);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }
        .stat-label { 
            color: var(--text-gray); 
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .table-container { 
            background: var(--bg-card);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px; 
            border: 1.5px solid var(--border); 
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { 
            padding: 18px 20px; 
            text-align: left; 
            border-bottom: 1px solid rgba(255,255,255,0.08); 
            font-size: 0.9rem; 
        }
        th { 
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            color: var(--text-gray); 
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        tr {
            transition: all 0.3s ease;
        }
        tr:hover { 
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.01);
        }
        
        /* å¾½ç« ä¸æŒ‰é’® */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .bg-success { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .bg-warning { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        .bg-danger { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .bg-primary { background: rgba(99, 102, 241, 0.2); color: #818CF8; }
        
        .btn { 
            padding: 8px 16px; 
            border-radius: 10px; 
            border: none; 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }
        .btn-outline { 
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1.5px solid var(--border); 
            color: var(--text-gray);
        }
        .btn-outline:hover, .btn-outline.active { 
            border-color: var(--primary); 
            color: var(--primary-light);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }
        .btn-sm { padding: 6px 12px; font-size: 0.75rem; }
        .btn-danger { 
            background: rgba(239,68,68,0.25);
            color: #EF4444;
            border: 1.5px solid rgba(239,68,68,0.4);
        }
        .btn-danger:hover {
            background: rgba(239,68,68,0.35);
            transform: translateY(-2px) scale(1.05);
        }
        .btn-success {
            background: rgba(16,185,129,0.25);
            color: #10B981;
            border: 1.5px solid rgba(16,185,129,0.4);
        }
        .btn-success:hover {
            background: rgba(16,185,129,0.35);
            transform: translateY(-2px) scale(1.05);
        }
        .btn-gray { 
            background: rgba(51, 65, 85, 0.8);
            color: white;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .btn-gray:hover {
            background: rgba(51, 65, 85, 1);
            transform: translateY(-2px);
        }

        /* åˆ—è¡¨é¡¹å¸ƒå±€ */
        .list-item { display: grid; grid-template-columns: 1fr 1fr 4fr 1fr; gap: 15px; padding: 15px; border-bottom: 1px solid var(--border); align-items: center; }
        
        /* åˆåŒæŸ¥çœ‹å¼¹çª— */
        .overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.88);
            backdrop-filter: blur(20px) saturate(180%);
            z-index: 1000; 
            justify-content: center; 
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .modal { 
            background: #fff; 
            width: 750px; 
            max-height: 90vh; 
            border-radius: 24px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            color: #333;
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            animation: modalPopIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPopIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .modal-header { 
            padding: 20px 30px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }
        .modal-body { 
            padding: 40px; 
            overflow-y: auto; 
            line-height: 1.8;
        }
        .contract-paper { 
            border: 1px solid #ddd; 
            padding: 40px; 
            background: #fff; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            margin-bottom: 25px; 
            position: relative;
            border-radius: 8px;
        }
        .stamp-seal { 
            position: absolute; 
            bottom: 50px; 
            right: 50px; 
            width: 130px; 
            height: 130px; 
            border: 3px solid #EF4444; 
            border-radius: 50%; 
            color: #EF4444; 
            font-weight: 900; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.2rem; 
            transform: rotate(-20deg); 
            opacity: 0.8; 
            pointer-events: none; 
            box-shadow: inset 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .echart-box { 
            height: 350px; 
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 20px; 
            border: 1.5px solid var(--border); 
            padding: 25px; 
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .echart-box:hover {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* å¿ƒè·³åŠ¨ç”»ç‚¹ */
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: #10B981;
            border-radius: 50%;
            animation: pulseHeartbeat 1.5s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }
        @keyframes pulseHeartbeat {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }
        
        /* Switchå¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(239, 68, 68, 0.3);
            transition: 0.3s;
            border-radius: 26px;
            border: 1.5px solid rgba(239, 68, 68, 0.5);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 2.5px;
            background-color: #EF4444;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input:checked + .slider {
            background-color: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
            background-color: #10B981;
        }
        
        /* å…¨å±€å¹¿æ’­å¼¹çª— */
        .broadcast-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.88);
            backdrop-filter: blur(20px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .broadcast-modal.active {
            display: flex;
        }
        .broadcast-card {
            background: var(--bg-card);
            backdrop-filter: blur(30px);
            border: 1.5px solid var(--border);
            border-radius: 24px;
            padding: 35px;
            width: 500px;
            max-width: 90vw;
            box-shadow: 0 32px 64px rgba(0,0,0,0.5);
            animation: modalPopIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .broadcast-card h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #FFFFFF, #E0E7FF);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .broadcast-card textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border: 1.5px solid var(--border);
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            resize: vertical;
            outline: none;
            margin-bottom: 20px;
            font-family: inherit;
        }
        .broadcast-card textarea:focus {
            border-color: var(--primary);
            background: rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo" style="display:flex; align-items:center; gap:12px;">
            <img src="assets/icons/logo-square-master.png.png" alt="æ™ºæ…§å®¶æ•™æ¡¥ - æ€»æ§ä¸­å¿ƒ" style="height:40px; width:auto;" onerror="this.style.display='none';">
            <span style="font-size:1rem; font-weight:700; color:white;">æ€»æ§ä¸­å¿ƒ</span>
        </div>
        <div class="nav-item active" onclick="switchView('dashboard', this)"><i class="fas fa-chart-line"></i> æ•°æ®çœ‹æ¿</div>
        <div class="nav-item" onclick="switchView('tutors', this)"><i class="fas fa-chalkboard-teacher"></i> æ•™å‘˜å®¡æ ¸ <span class="badge bg-danger" id="badgeTutor" style="display:none">0</span></div>
        <div class="nav-item" onclick="switchView('resources', this)"><i class="fas fa-folder-open"></i> èµ„æºå®¡æ ¸ <span class="badge bg-danger" id="badgeRes" style="display:none">0</span></div>
        <div class="nav-item" onclick="switchView('withdrawals', this)"><i class="fas fa-wallet"></i> æç°å¤„ç† <span class="badge bg-danger" id="badgeWith" style="display:none">0</span></div>
        <div class="nav-item" onclick="switchView('bookings', this)"><i class="fas fa-calendar-check"></i> è®¢å•ç®¡ç†</div>
        <div class="nav-item" onclick="switchView('users', this)"><i class="fas fa-users"></i> ç”¨æˆ·ç®¡æ§</div>
        <div class="nav-item" onclick="switchView('finance', this)"><i class="fas fa-chart-bar"></i> è´¢åŠ¡æŠ¥è¡¨</div>
        <div class="nav-item" onclick="switchView('cms', this)"><i class="fas fa-bullhorn"></i> å…¬å‘Š/å†…å®¹</div>
        <div class="nav-item" style="margin-top:auto; color:#EF4444;" onclick="if(confirm('é€€å‡ºç™»å½•ï¼Ÿ')) location.href='index.html'"><i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•</div>
    </div>

    <div class="main">
        <div id="view-dashboard" class="view active">
            <div class="header"><h2>ğŸ›ï¸ è¿è¥æŒ‡æŒ¥ä¸­å¿ƒ</h2></div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">æ³¨å†Œç”¨æˆ·</div>
                    <div class="stat-val" id="stUsers">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å…¥é©»æ•™å‘˜</div>
                    <div class="stat-val" id="stTutors">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ‰æ•ˆè®¢å•</div>
                    <div class="stat-val" id="stOrders">-</div>
                </div>
                <div class="stat-card" style="position:relative;">
                    <div class="stat-label">å®æ—¶åœ¨çº¿äººæ•°</div>
                    <div class="stat-val" style="display:flex; align-items:center; gap:10px;">
                        <span id="stOnlineUsers">-</span>
                        <div class="pulse-dot"></div>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-gray); margin-top:8px;">å¿ƒè·³ç›‘æ§ä¸­...</div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:20px;">
                <div class="echart-box" id="chartRevenue" style="height:380px;"></div>
                <div class="echart-box" id="chartUserTrend" style="height:380px;"></div>
            </div>
            <div class="echart-box" id="chartPie" style="height:350px;"></div>
        </div>

        <div id="view-tutors" class="view">
            <div class="header">
                <h2>æ•™å‘˜å…¥é©»å®¡æ ¸</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="tutorSearch" placeholder="æœç´¢å§“å/æ‰‹æœº..." style="padding:8px 15px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:white; outline:none; width:200px;" onkeyup="filterTutors()">
                    <button class="btn btn-primary" onclick="loadVerifyTutors()"><i class="fas fa-sync"></i> åˆ·æ–°</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th><input type="checkbox" id="checkAllTutors" onchange="toggleAllTutors(this)"></th><th>å§“å</th><th>å­¦æ ¡/ä¸“ä¸š</th><th>æ•™é¾„</th><th>æ‰‹æœº</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="tutorVerifyList"></tbody>
                </table>
            </div>
            <div style="margin-top:15px;">
                <button class="btn btn-success" onclick="batchApproveTutors()"><i class="fas fa-check-double"></i> æ‰¹é‡é€šè¿‡é€‰ä¸­</button>
                <button class="btn btn-danger" onclick="batchRejectTutors()"><i class="fas fa-times"></i> æ‰¹é‡æ‹’ç»é€‰ä¸­</button>
            </div>
        </div>

        <div id="view-resources" class="view">
            <div class="header">
                <h2>ä¸Šä¼ èµ„æºå®¡æ ¸</h2>
                <input type="text" id="resSearch" placeholder="æœç´¢èµ„æºæ ‡é¢˜..." style="padding:8px 15px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:white; outline:none; width:200px;" onkeyup="filterResources()">
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>æ ‡é¢˜</th><th>å‘å¸ƒè€…</th><th>ä»·æ ¼</th><th>æ–‡ä»¶</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="resVerifyList"></tbody>
                </table>
            </div>
        </div>

        <div id="view-withdrawals" class="view">
            <div class="header"><h2>æç°ç”³è¯·å¤„ç†</h2></div>
            <div class="table-container">
                <table>
                    <thead><tr><th>ç”¨æˆ·</th><th>é‡‘é¢</th><th>æ”¶æ¬¾è´¦å·</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="withList"></tbody>
                </table>
            </div>
        </div>

        <div id="view-bookings" class="view">
            <div class="header">
                <h2>è®¢å•æŸ¥è¯¢ä¸ç›‘ç®¡</h2>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="bookingSearch" placeholder="æœç´¢è®¢å•ID/å­¦ç”Ÿ/æ•™å‘˜..." style="padding:8px 15px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:white; outline:none; width:220px;" onkeyup="filterBookings()">
                    <select id="bookingStatusFilter" style="padding:8px 15px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:white; outline:none;" onchange="filterBookings()">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="å¾…ç¡®è®¤">å¾…ç¡®è®¤</option>
                        <option value="å·²é€šè¿‡">å·²é€šè¿‡</option>
                        <option value="å·²æ”¯ä»˜">å·²æ”¯ä»˜</option>
                        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                        <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadBookings()"><i class="fas fa-sync"></i> åˆ·æ–°</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å­¦ç”Ÿ</th>
                            <th>æ•™å‘˜</th>
                            <th>æ—¶é—´</th>
                            <th>æ–¹å¼</th> <th>é‡‘é¢</th>
                            <th>çŠ¶æ€</th>
                            <th>åˆåŒ</th> <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="bookingList"></tbody>
                </table>
            </div>
        </div>

        <div id="view-users" class="view">
            <div class="header">
                <h2>ç”¨æˆ·å°ç¦ä¸é‡ç½®</h2>
                <div>
                    <button class="btn btn-outline active" onclick="loadUsers('student')">å­¦ç”Ÿ</button>
                    <button class="btn btn-outline" onclick="loadUsers('teacher')">æ•™å‘˜</button>
                </div>
            </div>
            <div class="table-container"><div id="userList" style="padding:10px;"></div></div>
            <h3 style="margin:20px 0 10px;">æœ€è¿‘è¯„ä»·</h3>
            <div class="table-container"><div id="reviewList" style="padding:10px;"></div></div>
        </div>

        <div id="view-finance" class="view">
            <div class="header">
                <h2>ğŸ’° è´¢åŠ¡å¯¹è´¦ä¸­å¿ƒ</h2>
                <button class="btn btn-primary" onclick="exportFinanceCSV()"><i class="fas fa-download"></i> å¯¼å‡ºCSV</button>
            </div>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="stat-card">
                    <div class="stat-label">å¹³å°æ€»æ”¶å…¥</div>
                    <div class="stat-val" style="color:#10B981" id="financeTotal">Â¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å°æŠ½æˆ</div>
                    <div class="stat-val" style="color:#F59E0B" id="financeCommission">Â¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ•™å‘˜åˆ†æˆ</div>
                    <div class="stat-val" style="color:#6366F1" id="financePayout">Â¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¾…ç»“ç®—</div>
                    <div class="stat-val" style="color:#EF4444" id="financePending">Â¥0</div>
                </div>
            </div>
            <div class="table-container" style="margin-top:25px;">
                <table>
                    <thead>
                        <tr>
                            <th>è®¢å•ID</th>
                            <th>å­¦å‘˜</th>
                            <th>æ•™å‘˜</th>
                            <th>è®¢å•é‡‘é¢</th>
                            <th>æŠ½æˆæ¯”ä¾‹</th>
                            <th>å¹³å°æ”¶å…¥</th>
                            <th>æ•™å‘˜åˆ†æˆ</th>
                            <th>çŠ¶æ€</th>
                            <th>ç»“ç®—æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="financeList"></tbody>
                </table>
            </div>
        </div>

        <div id="view-cms" class="view">
            <div class="header"><h2>å†…å®¹å‘å¸ƒç³»ç»Ÿ</h2></div>
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="stat-card">
                    <h3>ğŸ“¢ å‘å¸ƒå…¬å‘Š</h3>
                    <input id="annoTitle" style="width:100%; padding:10px; margin:10px 0; background:#334155; border:none; color:white; border-radius:8px;" placeholder="æ ‡é¢˜">
                    <textarea id="annoContent" style="width:100%; padding:10px; height:80px; background:#334155; border:none; color:white; border-radius:8px;" placeholder="å†…å®¹"></textarea>
                    <button class="btn btn-primary" style="margin-top:10px;" onclick="postAnno()">å‘å¸ƒå¹¶æ¨é€å…¨å‘˜</button>
                </div>
                <div class="stat-card">
                    <h3>ğŸ”” å…¨å±€å¹¿æ’­ï¼ˆå®æ—¶æ¨é€ï¼‰</h3>
                    <p style="font-size:0.85rem; color:var(--text-gray); margin-bottom:15px;">å‘æ‰€æœ‰åœ¨çº¿ç”¨æˆ·å‘é€å³æ—¶é€šçŸ¥</p>
                    <textarea id="broadcastContent" style="width:100%; padding:12px; min-height:80px; background:rgba(0,0,0,0.3); border:1.5px solid var(--border); border-radius:8px; color:white; resize:vertical;" placeholder="è¾“å…¥å¹¿æ’­å†…å®¹..."></textarea>
                    <button class="btn btn-primary" style="margin-top:10px; background:linear-gradient(135deg, #F59E0B, #D97706);" onclick="openBroadcastModal()"><i class="fas fa-broadcast-tower"></i> å‘é€å…¨å±€å¹¿æ’­</button>
                </div>
            </div>
            <div class="stats-grid" style="grid-template-columns: 1fr;">
                <div class="stat-card">
                    <h3>ğŸ”§ å¸¸è§é—®é¢˜ç®¡ç†</h3>
                    <input id="faqQ" style="width:100%; padding:10px; margin:10px 0; background:#334155; border:none; color:white; border-radius:8px;" placeholder="é—®é¢˜">
                    <textarea id="faqA" style="width:100%; padding:10px; height:80px; background:#334155; border:none; color:white; border-radius:8px;" placeholder="å›ç­”"></textarea>
                    <button class="btn btn-success" style="margin-top:10px;" onclick="addFaq()">æ·»åŠ FAQ</button>
                </div>
            </div>
            <h3 style="margin-top:25px;">ç”¨æˆ·åé¦ˆ</h3>
            <div class="table-container"><table id="feedbackList"></table></div>
        </div>
        
        <!-- å…¨å±€å¹¿æ’­ç¡®è®¤å¼¹çª— -->
        <div class="broadcast-modal" id="broadcastModal">
            <div class="broadcast-card">
                <h3><i class="fas fa-broadcast-tower"></i> ç¡®è®¤å‘é€å…¨å±€å¹¿æ’­</h3>
                <textarea id="broadcastConfirmContent" placeholder="å¹¿æ’­å†…å®¹å°†å‘é€ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·..."></textarea>
                <div style="display:flex; gap:12px; justify-content:flex-end;">
                    <button class="btn btn-outline" onclick="closeBroadcastModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="sendBroadcast()" style="background:linear-gradient(135deg, #F59E0B, #D97706);"><i class="fas fa-paper-plane"></i> ç¡®è®¤å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="contractModal">
        <div class="modal">
            <div class="modal-header">
                <span style="font-weight:bold; font-size:1.1rem;">ğŸ“ è®¢å•åˆåŒæ¡£æ¡ˆ</span>
                <button class="btn btn-outline" onclick="document.getElementById('contractModal').style.display='none'">å…³é—­</button>
            </div>
            <div class="modal-body" id="contractContent"></div>
        </div>
    </div>

    <script>
        let currentUserType = 'student';

        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            initCharts();
            // è‡ªåŠ¨åŠ è½½ç¬¬ä¸€å±æ•°æ®
            loadVerifyTutors();
            loadVerifyResources();
            loadWithdrawals();
        });

        function switchView(id, btn) {
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(btn) {
                document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
                btn.classList.add('active');
            }
            // æ‡’åŠ è½½
            if(id==='bookings') loadBookings();
            if(id==='users') { loadUsers('student'); loadReviews(); }
            if(id==='cms') loadFeedbacks();
            if(id==='finance') loadFinanceData();
        }

        function loadStats() {
            fetch('api/admin_api.php?action=get_stats').then(r=>r.json()).then(res=>{
                const d = res.data;
                document.getElementById('stUsers').innerText = d.users;
                document.getElementById('stTutors').innerText = d.tutors;
                document.getElementById('stOrders').innerText = d.orders;
                document.getElementById('stIncome').innerText = d.income;
                // Badges
                if(d.pending.tutors>0) { document.getElementById('badgeTutor').innerText=d.pending.tutors; document.getElementById('badgeTutor').style.display='inline-block'; }
                if(d.pending.resources>0) { document.getElementById('badgeRes').innerText=d.pending.resources; document.getElementById('badgeRes').style.display='inline-block'; }
                if(d.pending.withdrawals>0) { document.getElementById('badgeWith').innerText=d.pending.withdrawals; document.getElementById('badgeWith').style.display='inline-block'; }
            });
        }

        // ================ å®æ—¶åœ¨çº¿äººæ•°ï¼ˆæ¨¡æ‹Ÿï¼‰ ================
        function updateOnlineUsers() {
            // æ¨¡æ‹Ÿå®æ—¶åœ¨çº¿äººæ•°ï¼ˆå®é™…é¡¹ç›®ä¸­åº”ä»WebSocketæˆ–APIè·å–ï¼‰
            const baseCount = parseInt(document.getElementById('stUsers')?.innerText || '100');
            const online = Math.floor(baseCount * (0.15 + Math.random() * 0.1)); // 15-25%åœ¨çº¿ç‡
            const el = document.getElementById('stOnlineUsers');
            if(el) el.innerText = online;
        }
        setInterval(updateOnlineUsers, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡

        function initCharts() {
            // ä»Šæ—¥äº¤æ˜“é¢æ›²çº¿å›¾
            let revenueChart = echarts.init(document.getElementById('chartRevenue'));
            revenueChart.setOption({
                backgroundColor: 'transparent',
                title: { 
                    text: 'ğŸ“Š ä»Šæ—¥äº¤æ˜“é¢è¶‹åŠ¿', 
                    textStyle: {color:'#E0E7FF', fontSize: 16, fontWeight: 'bold'},
                    left: 'center',
                    top: 10
                },
                tooltip: { 
                    trigger: 'axis',
                    backgroundColor: 'rgba(30, 41, 59, 0.95)',
                    borderColor: '#6366F1',
                    borderWidth: 1,
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        return `${params[0].name}<br/>äº¤æ˜“é¢: Â¥${params[0].value}`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', top: '15%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    data: Array.from({length:24}, (_,i) => i + ':00'),
                    axisLabel: {color:'#94A3B8', fontSize: 10, rotate: 45},
                    axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: {color:'#94A3B8', fontSize: 12, formatter: 'Â¥{value}'},
                    axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                    splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
                },
                series: [{ 
                    data: Array.from({length:24}, () => Math.floor(Math.random() * 500 + 100)),
                    type: 'line', 
                    smooth: true,
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(245, 158, 11, 0.4)' },
                                { offset: 1, color: 'rgba(245, 158, 11, 0.05)' }
                            ]
                        }
                    },
                    itemStyle: {color:'#F59E0B'},
                    lineStyle: { width: 3, color: '#F59E0B' },
                    symbol: 'circle',
                    symbolSize: 6,
                    emphasis: {
                        itemStyle: { color: '#FCD34D', borderColor: '#fff', borderWidth: 2 }
                    }
                }]
            });
            
            // æ–°å¢ç”¨æˆ·è¶‹åŠ¿å›¾
            let userTrendChart = echarts.init(document.getElementById('chartUserTrend'));
            const last7Days = Array.from({length:7}, (_,i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6-i));
                return (d.getMonth()+1) + '/' + d.getDate();
            });
            userTrendChart.setOption({
                backgroundColor: 'transparent',
                title: { 
                    text: 'ğŸ‘¥ æ–°å¢ç”¨æˆ·è¶‹åŠ¿', 
                    textStyle: {color:'#E0E7FF', fontSize: 16, fontWeight: 'bold'},
                    left: 'center',
                    top: 10
                },
                tooltip: { 
                    trigger: 'axis',
                    backgroundColor: 'rgba(30, 41, 59, 0.95)',
                    borderColor: '#10B981',
                    borderWidth: 1,
                    textStyle: { color: '#fff' }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', top: '15%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    data: last7Days,
                    axisLabel: {color:'#94A3B8', fontSize: 11},
                    axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: {color:'#94A3B8', fontSize: 12},
                    axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                    splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
                },
                series: [{ 
                    data: Array.from({length:7}, () => Math.floor(Math.random() * 50 + 10)),
                    type: 'bar', 
                    itemStyle: {
                        borderRadius: [6, 6, 0, 0],
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#10B981' },
                            { offset: 1, color: '#059669' }
                        ])
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#34D399' },
                                { offset: 1, color: '#10B981' }
                            ])
                        }
                    }
                }]
            });
            
            let c2 = echarts.init(document.getElementById('chartPie'));
            c2.setOption({
                title: { 
                    text: 'ğŸ“Š è®¢å•åˆ†ç±»å æ¯”', 
                    textStyle: {color:'#E0E7FF', fontSize: 16, fontWeight: 'bold'},
                    left: 'center',
                    top: 10
                },
                tooltip: { 
                    trigger: 'item',
                    backgroundColor: 'rgba(30, 41, 59, 0.95)',
                    borderColor: '#6366F1',
                    borderWidth: 1,
                    textStyle: { color: '#fff' },
                    formatter: '{b}: Â¥{c} ({d}%)'
                },
                legend: {
                    bottom: 10,
                    left: 'center',
                    textStyle: { color: '#94A3B8', fontSize: 12 }
                },
                series: [{
                    type: 'pie', 
                    radius: ['45%', '75%'],
                    center: ['50%', '50%'],
                    avoidLabelOverlap: true,
                    itemStyle: {
                        borderRadius: 8,
                        borderColor: '#0F172A',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        color: '#E0E7FF',
                        fontSize: 12,
                        formatter: '{b}\n{d}%'
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(99, 102, 241, 0.5)'
                        }
                    },
                    data: [
                        { value: 1048, name: 'å°å­¦è¾…å¯¼', itemStyle: { color: '#6366F1' } },
                        { value: 735, name: 'åˆä¸­æå‡', itemStyle: { color: '#818CF8' } },
                        { value: 580, name: 'é«˜ä¸­å†²åˆº', itemStyle: { color: '#A855F7' } },
                        { value: 484, name: 'å…´è¶£ç‰¹é•¿', itemStyle: { color: '#F59E0B' } }
                    ]
                }]
            });
        }

        // --- å®¡æ ¸ç±»åŠŸèƒ½ (å¢å¼ºç‰ˆï¼šæ”¯æŒæœç´¢å’Œæ‰¹é‡æ“ä½œ) ---
        let allTutorsData = [];
        function loadVerifyTutors(){
            fetch('api/admin_api.php?action=get_pending_tutors').then(r=>r.json()).then(res=>{
                allTutorsData = res.data;
                renderTutorsTable(allTutorsData);
            });
        }
        function renderTutorsTable(data) {
            let h=''; 
            if(data.length===0) {
                h='<tr><td colspan="6" style="text-align:center;padding:20px;color:gray">æš‚æ— å¾…å®¡æ ¸æ•™å‘˜</td></tr>';
            } else {
                data.forEach(t=>{ 
                    h+=`<tr>
                        <td><input type="checkbox" class="tutor-checkbox" value="${t.id}"></td>
                        <td>${t.name}</td>
                        <td>${t.school}/${t.major}</td>
                        <td>${t.experience}</td>
                        <td>${t.phone}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="verifyTutor(${t.id},'å·²é€šè¿‡')">é€šè¿‡</button> 
                            <button class="btn btn-danger btn-sm" onclick="verifyTutor(${t.id},'å·²æ‹’ç»')">æ‹’ç»</button>
                        </td>
                    </tr>`; 
                });
            }
            document.getElementById('tutorVerifyList').innerHTML=h;
        }
        function filterTutors() {
            const keyword = document.getElementById('tutorSearch').value.toLowerCase();
            const filtered = allTutorsData.filter(t => 
                t.name.toLowerCase().includes(keyword) || 
                t.phone.includes(keyword) ||
                t.school.toLowerCase().includes(keyword)
            );
            renderTutorsTable(filtered);
        }
        function toggleAllTutors(checkbox) {
            document.querySelectorAll('.tutor-checkbox').forEach(cb => cb.checked = checkbox.checked);
        }
        function batchApproveTutors() {
            const selected = Array.from(document.querySelectorAll('.tutor-checkbox:checked')).map(cb => cb.value);
            if(selected.length === 0) return alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„æ•™å‘˜');
            if(!confirm(`ç¡®è®¤æ‰¹é‡é€šè¿‡ ${selected.length} ä½æ•™å‘˜ï¼Ÿ`)) return;
            selected.forEach(id => verifyTutor(id, 'å·²é€šè¿‡', true));
            setTimeout(() => loadVerifyTutors(), 500);
        }
        function batchRejectTutors() {
            const selected = Array.from(document.querySelectorAll('.tutor-checkbox:checked')).map(cb => cb.value);
            if(selected.length === 0) return alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„æ•™å‘˜');
            if(!confirm(`ç¡®è®¤æ‰¹é‡æ‹’ç» ${selected.length} ä½æ•™å‘˜ï¼Ÿ`)) return;
            selected.forEach(id => verifyTutor(id, 'å·²æ‹’ç»', true));
            setTimeout(() => loadVerifyTutors(), 500);
        }
        function verifyTutor(id, s, silent){ 
            if(!silent && !confirm(s+'?')) return;
            fetch('api/admin_api.php?action=verify_tutor',{method:'POST',body:new URLSearchParams({id,status:s})}).then(()=>{
                if(!silent) {
                    loadVerifyTutors();
                    loadStats();
                }
            }); 
        }

        let allResourcesData = [];
        function loadVerifyResources(){
            fetch('api/admin_api.php?action=get_pending_resources').then(r=>r.json()).then(res=>{
                allResourcesData = res.data;
                renderResourcesTable(allResourcesData);
            });
        }
        function renderResourcesTable(data) {
            let h=''; 
            if(data.length===0) {
                h='<tr><td colspan="5" style="text-align:center;padding:20px;color:gray">æš‚æ— å¾…å®¡æ ¸èµ„æº</td></tr>';
            } else {
                data.forEach(r=>{ 
                    h+=`<tr>
                        <td>${r.title}</td>
                        <td>${r.uploader_phone}</td>
                        <td>Â¥${r.price}</td>
                        <td><a href="${r.file_path}" target="_blank" style="color:var(--primary); text-decoration:none;" onmouseover="this.style.textDecoration='underline'">é¢„è§ˆ</a></td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="verifyRes(${r.id},'approved')">é€šè¿‡</button> 
                            <button class="btn btn-danger btn-sm" onclick="verifyRes(${r.id},'rejected')">é©³å›</button>
                        </td>
                    </tr>`; 
                });
            }
            document.getElementById('resVerifyList').innerHTML=h;
        }
        function filterResources() {
            const keyword = document.getElementById('resSearch').value.toLowerCase();
            const filtered = allResourcesData.filter(r => 
                r.title.toLowerCase().includes(keyword) || 
                r.uploader_phone.includes(keyword)
            );
            renderResourcesTable(filtered);
        }
        function verifyRes(id, s){ fetch('api/admin_api.php?action=verify_resource',{method:'POST',body:new URLSearchParams({id,status:s})}).then(()=>{loadVerifyResources();}); }

        function loadWithdrawals(){
            fetch('api/admin_api.php?action=get_withdrawals').then(r=>r.json()).then(res=>{
                let h=''; if(res.data.length===0) h='<tr><td colspan="5" style="text-align:center;padding:20px;color:gray">æš‚æ— æç°ç”³è¯·</td></tr>';
                else res.data.forEach(w=>{
                    let op = w.status==='pending' ? `<button class="btn btn-success" onclick="handleWith(${w.id},'approve')">æ‰“æ¬¾</button> <button class="btn btn-danger" onclick="handleWith(${w.id},'reject')">é©³å›</button>` : `<span class="badge ${w.status==='approved'?'bg-success':'bg-danger'}">${w.status}</span>`;
                    h+=`<tr><td>${w.user_phone}</td><td style="font-weight:bold;color:#F59E0B">Â¥${w.amount}</td><td>${w.account_info}</td><td>${w.create_time}</td><td>${op}</td></tr>`;
                });
                document.getElementById('withList').innerHTML=h;
            });
        }
        function handleWith(id, act){ if(confirm('ç¡®è®¤æ“ä½œï¼Ÿ')) fetch('api/admin_api.php?action=handle_withdrawal',{method:'POST',body:new URLSearchParams({id,act})}).then(()=>{loadWithdrawals();}); }

        // --- è®¢å•ç®¡ç† (å¢å¼ºç‰ˆï¼šæ”¯æŒæœç´¢å’Œç­›é€‰) ---
        let allBookingsData = [];
        function loadBookings(){
            fetch('api/admin_api.php?action=get_all_bookings').then(r=>r.json()).then(res=>{
                allBookingsData = res.data;
                renderBookingsTable(allBookingsData);
            });
        }
        function renderBookingsTable(data) {
            let h=''; 
            if(data.length===0) {
                h='<tr><td colspan="9" style="text-align:center;padding:20px;color:gray">æš‚æ— è®¢å•</td></tr>';
            } else {
                data.forEach(b=>{
                    let statusClass = 'bg-warning';
                    if(b.status==='å·²æ”¯ä»˜'||b.status==='å·²å®Œæˆ') statusClass='bg-success';
                    if(b.status==='å·²å–æ¶ˆ'||b.status==='å·²æ‹’ç»') statusClass='bg-danger';

                    // 1. æˆè¯¾æ–¹å¼æ ‡ç­¾ (çº¢/è“åŒºåˆ†)
                    let typeBadge = b.class_type === 'çº¿ä¸‹ä¸Šé—¨' 
                        ? `<span class="badge bg-danger"><i class="fas fa-home"></i> çº¿ä¸‹</span>` 
                        : `<span class="badge bg-primary"><i class="fas fa-laptop"></i> çº¿ä¸Š</span>`;

                    h+=`<tr>
                        <td>${b.id}</td>
                        <td>${b.user_phone}</td>
                        <td>${b.tutor_name}</td>
                        <td>${b.lesson_time}</td>
                        <td>${typeBadge}</td>
                        <td style="font-weight:bold">Â¥${b.price}</td>
                        <td><span class="badge ${statusClass}">${b.status}</span></td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="viewContract('${b.id}', '${b.tutor_name}', '${b.user_phone}', '${b.class_type}', '${b.price}', '${b.create_time}')">
                                <i class="fas fa-file-contract"></i> åè®®
                            </button>
                        </td>
                        <td><button class="btn btn-danger btn-sm" onclick="delBooking(${b.id})">åˆ </button></td>
                    </tr>`;
                });
            }
            document.getElementById('bookingList').innerHTML=h;
        }
        function filterBookings() {
            const keyword = document.getElementById('bookingSearch').value.toLowerCase();
            const statusFilter = document.getElementById('bookingStatusFilter').value;
            let filtered = allBookingsData.filter(b => {
                const matchKeyword = !keyword || 
                    b.id.toString().includes(keyword) ||
                    b.user_phone.includes(keyword) ||
                    b.tutor_name.toLowerCase().includes(keyword);
                const matchStatus = !statusFilter || b.status === statusFilter;
                return matchKeyword && matchStatus;
            });
            renderBookingsTable(filtered);
        }
        function delBooking(id){ if(confirm('ç¡®å®šåˆ é™¤æ­¤è®¢å•è®°å½•ï¼Ÿ(ä¸å¯æ¢å¤)')) fetch('api/admin_api.php?action=delete_booking',{method:'POST',body:new URLSearchParams({id})}).then(()=>{loadBookings();}); }

        // âœ¨âœ¨âœ¨ æ ¸å¿ƒï¼šæŸ¥çœ‹åˆåŒ (å¤ç”¨é€»è¾‘) âœ¨âœ¨âœ¨
        function viewContract(id, tName, uPhone, type, price, date) {
            const isOffline = type === 'çº¿ä¸‹ä¸Šé—¨';
            const title = isOffline ? 'çº¿ä¸‹ä¸Šé—¨å®¶æ•™æœåŠ¡åè®®' : 'åœ¨çº¿äº‘è¯¾å ‚æœåŠ¡åè®®';
            const color = isOffline ? '#d93025' : '#6366F1';
            
            // å·®å¼‚åŒ–æ¡æ¬¾
            let terms = isOffline ? 
                `<p>1. <strong>æœåŠ¡æ¨¡å¼ï¼š</strong> çº¿ä¸‹ä¸Šé—¨ (é¢å¯¹é¢)ã€‚æ•™å‘˜éœ€è‡ªè¡Œå‰å¾€å­¦å‘˜æŒ‡å®šåœ°ç‚¹ã€‚</p>
                 <p>2. <strong>å®‰å…¨è´£ä»»ï¼š</strong> åŒæ–¹éœ€å…±åŒç»´æŠ¤æ•™å­¦ç¯å¢ƒå®‰å…¨ã€‚æ•™å‘˜å¾€è¿”é€”ä¸­æ³¨æ„äº¤é€šå®‰å…¨ã€‚</p>` :
                `<p>1. <strong>æœåŠ¡æ¨¡å¼ï¼š</strong> çº¿ä¸Šäº‘æ•™å®¤ (è¿œç¨‹)ã€‚åŒæ–¹é€šè¿‡ç½‘ç»œè§†é¢‘è¿›è¡Œæ•™å­¦ã€‚</p>
                 <p>2. <strong>ç½‘ç»œä¿éšœï¼š</strong> åŒæ–¹åº”ä¿éšœç½‘ç»œé€šç•…ï¼Œç¦æ­¢ç§è‡ªå½•å±ä¼ æ’­ã€‚</p>`;

            const html = `
                <div class="contract-paper">
                    <h2 style="text-align:center; color:${color}; margin-bottom:20px;">${title}</h2>
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:0.9rem; color:#666;">
                        <span>åˆåŒç¼–å·ï¼šWTB-ADMIN-${id}</span>
                        <span>ç­¾ç½²æ—¥æœŸï¼š${date.split(' ')[0]}</span>
                    </div>
                    <div style="line-height:1.8; color:#333;">
                        <p><strong>ç”²æ–¹ (å­¦å‘˜)ï¼š</strong> ${uPhone}</p>
                        <p><strong>ä¹™æ–¹ (æ•™å‘˜)ï¼š</strong> ${tName}</p>
                        <p><strong>ä¸™æ–¹ (å¹³å°)ï¼š</strong> æ™ºæ…§å®¶æ•™æ¡¥ç›‘ç®¡ä¸­å¿ƒ</p>
                        <hr style="border:none; border-top:1px dashed #ddd; margin:15px 0;">
                        ${terms}
                        <p>3. <strong>æœåŠ¡è´¹ç”¨ï¼š</strong> Â¥${price} (èµ„é‡‘ç”±å¹³å°æ‰˜ç®¡ï¼Œå®Œè¯¾åç»“ç®—)</p>
                        <p>4. <strong>ç›‘ç®¡è¯´æ˜ï¼š</strong> æœ¬è®¢å•å—å¹³å°å…¨æµç¨‹ç›‘ç®¡ï¼Œå¦‚æœ‰çº çº·ï¼Œä»¥å¹³å°åå°æ•°æ®ä¸ºå‡†ã€‚</p>
                    </div>
                    
                    <div style="margin-top:40px; display:flex; justify-content:space-between; align-items:flex-end;">
                        <div>
                            <p>ç”²æ–¹ç­¾å­—ï¼š<span style="font-family:cursive; font-size:1.2rem;">${uPhone}</span></p>
                            <p>ä¹™æ–¹ç­¾å­—ï¼š<span style="font-family:cursive; font-size:1.2rem;">${tName}</span></p>
                        </div>
                        <div class="stamp-seal" style="position:relative; right:0; bottom:0; opacity:0.8;">
                            <div style="border:2px solid #d93025; width:100px; height:100px; border-radius:50%; display:flex; align-items:center; justify-content:center; text-align:center; font-size:1rem; color:#d93025; transform:rotate(-15deg);">
                                æ™ºæ…§å®¶æ•™<br>å·²å½’æ¡£
                            </div>
                        </div>
                    </div>
                </div>
                <div style="text-align:center;">
                    <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ æ‰“å° / å¦å­˜ä¸º PDF</button>
                </div>
            `;
            
            document.getElementById('contractContent').innerHTML = html;
            document.getElementById('contractModal').style.display = 'flex';
        }

        // --- ç”¨æˆ·ä¸CMSç®¡ç†ï¼ˆSwitchå¼€å…³ç‰ˆï¼‰ ---
        function loadUsers(type){
            currentUserType = type;
            fetch(`api/admin_api.php?action=get_users&type=${type}`).then(r=>r.json()).then(res=>{
                let h=''; 
                if(res.data.length===0) {
                    h='<p style="text-align:center; padding:30px; color:var(--text-gray);">æš‚æ— æ•°æ®</p>';
                } else {
                    res.data.forEach(u=>{ 
                        const isBanned = u.is_banned == 1;
                        h+=`
                            <div class="list-item">
                                <div>ID: ${u.id}</div>
                                <div>${u.username||u.name}</div>
                                <div>${u.phone}</div>
                                <div>ä½™é¢: Â¥${u.balance||0}</div>
                                <div style="display:flex; align-items:center; gap:15px;">
                                    <label class="switch" title="${isBanned ? 'ç‚¹å‡»è§£å°' : 'ç‚¹å‡»å°ç¦'}">
                                        <input type="checkbox" ${isBanned ? '' : 'checked'} onchange="toggleBanWithConfirm(${u.id}, this.checked)">
                                        <span class="slider"></span>
                                    </label>
                                    <span style="font-size:0.85rem; color:var(--text-gray);">${isBanned ? 'å·²å°ç¦' : 'æ­£å¸¸'}</span>
                                    <button class="btn btn-gray btn-sm" onclick="resetPwd(${u.id})"><i class="fas fa-key"></i> é‡ç½®å¯†ç </button>
                                </div>
                            </div>
                        `;
                    });
                }
                document.getElementById('userList').innerHTML=h;
            });
        }
        function toggleBanWithConfirm(id, checked) {
            const action = checked ? 'è§£å°' : 'å°ç¦';
            if(!confirm(`ç¡®è®¤${action}æ­¤ç”¨æˆ·ï¼Ÿ`)) {
                // æ¢å¤å¼€å…³çŠ¶æ€
                const switchEl = event.target;
                switchEl.checked = !checked;
                return;
            }
            const status = checked ? 0 : 1;
            fetch('api/admin_api.php?action=toggle_ban', {
                method: 'POST',
                body: new URLSearchParams({type: currentUserType, id, is_banned: status})
            }).then(() => {
                loadUsers(currentUserType);
            }).catch(() => {
                // å¤±è´¥æ—¶æ¢å¤çŠ¶æ€
                event.target.checked = !checked;
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
        function resetPwd(id){ 
            if(!confirm('é‡ç½®å¯†ç ä¸º 123456ï¼Ÿ')) return; 
            fetch('api/admin_api.php?action=reset_password', {
                method: 'POST',
                body: new URLSearchParams({type: currentUserType, id})
            }).then(r=>r.json()).then(d=>{
                alert(d.message); 
            }); 
        }
        
        function loadReviews(){ fetch('api/admin_api.php?action=get_all_reviews').then(r=>r.json()).then(res=>{ let h=''; if(res.data.length===0) h='<p style="text-align:center;color:gray">æš‚æ— è¯„ä»·</p>'; else res.data.forEach(r=>{ h+=`<div class="list-item" style="grid-template-columns:1fr 1fr 1fr 3fr 1fr"><div>${r.user_phone}</div><div>${r.tutor_name}</div><div style="color:#F59E0B">${r.rating}æ˜Ÿ</div><div>${r.content}</div><div><button class="btn btn-danger btn-sm" onclick="delReview(${r.id})">åˆ </button></div></div>`; }); document.getElementById('reviewList').innerHTML=h; }); }
        function delReview(id){ if(confirm('åˆ ï¼Ÿ')) fetch('api/admin_api.php?action=delete_review',{method:'POST',body:new URLSearchParams({id})}).then(()=>{loadReviews();}); }

        // ================ è´¢åŠ¡æŠ¥è¡¨ ================
        let financeData = [];
        function loadFinanceData() {
            fetch('api/admin_api.php?action=get_finance_report').then(r=>r.json()).then(res=>{
                if(res.status === 'success') {
                    financeData = res.data.orders || [];
                    const stats = res.data.stats;
                    
                    document.getElementById('financeTotal').innerText = `Â¥${stats.total.toFixed(2)}`;
                    document.getElementById('financeCommission').innerText = `Â¥${stats.commission.toFixed(2)}`;
                    document.getElementById('financePayout').innerText = `Â¥${stats.payout.toFixed(2)}`;
                    document.getElementById('financePending').innerText = `Â¥${stats.pending.toFixed(2)}`;
                    
                    renderFinanceTable(financeData);
                }
            });
        }
        function renderFinanceTable(data) {
            let h = '';
            if(data.length === 0) {
                h = '<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text-gray);">æš‚æ— è´¢åŠ¡æ•°æ®</td></tr>';
            } else {
                data.forEach(order => {
                    const rate = order.commission_rate || 0.1;
                    const commission = order.price * rate;
                    const payout = order.price - commission;
                    const statusClass = order.status === 'å·²å®Œæˆ' ? 'bg-success' : order.status === 'å·²æ”¯ä»˜' ? 'bg-warning' : 'bg-primary';
                    h += `
                        <tr>
                            <td>${order.id}</td>
                            <td>${order.user_phone}</td>
                            <td>${order.tutor_name}</td>
                            <td style="font-weight:bold;color:#F59E0B">Â¥${order.price}</td>
                            <td>${(rate * 100).toFixed(0)}%</td>
                            <td style="color:#10B981">Â¥${commission.toFixed(2)}</td>
                            <td style="color:#6366F1">Â¥${payout.toFixed(2)}</td>
                            <td><span class="badge ${statusClass}">${order.status}</span></td>
                            <td>${order.settle_time || '-'}</td>
                        </tr>
                    `;
                });
            }
            document.getElementById('financeList').innerHTML = h;
        }
        function exportFinanceCSV() {
            if(financeData.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            const headers = ['è®¢å•ID', 'å­¦å‘˜', 'æ•™å‘˜', 'è®¢å•é‡‘é¢', 'æŠ½æˆæ¯”ä¾‹', 'å¹³å°æ”¶å…¥', 'æ•™å‘˜åˆ†æˆ', 'çŠ¶æ€', 'ç»“ç®—æ—¶é—´'];
            let csv = headers.join(',') + '\n';
            financeData.forEach(order => {
                const rate = order.commission_rate || 0.1;
                const commission = order.price * rate;
                const payout = order.price - commission;
                csv += `${order.id},${order.user_phone},${order.tutor_name},${order.price},${(rate * 100).toFixed(0)}%,${commission.toFixed(2)},${payout.toFixed(2)},${order.status},${order.settle_time || ''}\n`;
            });
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `è´¢åŠ¡æŠ¥è¡¨_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ================ å…¨å±€å¹¿æ’­ ================
        function openBroadcastModal() {
            const content = document.getElementById('broadcastContent').value.trim();
            if(!content) {
                alert('è¯·è¾“å…¥å¹¿æ’­å†…å®¹');
                return;
            }
            document.getElementById('broadcastConfirmContent').value = content;
            document.getElementById('broadcastModal').classList.add('active');
        }
        function closeBroadcastModal() {
            document.getElementById('broadcastModal').classList.remove('active');
        }
        function sendBroadcast() {
            const content = document.getElementById('broadcastConfirmContent').value.trim();
            if(!content) {
                alert('å¹¿æ’­å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            fetch('api/admin_api.php?action=broadcast_message', {
                method: 'POST',
                body: new URLSearchParams({content})
            }).then(r=>r.json()).then(res=>{
                if(res.status === 'success') {
                    alert('âœ… å…¨å±€å¹¿æ’­å·²å‘é€ï¼æ‰€æœ‰åœ¨çº¿ç”¨æˆ·å°†æ”¶åˆ°æ­¤æ¶ˆæ¯ã€‚');
                    document.getElementById('broadcastContent').value = '';
                    closeBroadcastModal();
                } else {
                    alert('å‘é€å¤±è´¥ï¼š' + (res.message || 'æœªçŸ¥é”™è¯¯'));
                }
            }).catch(err => {
                alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
        
        // CMS
        function postAnno(){ let t=document.getElementById('annoTitle').value,c=document.getElementById('annoContent').value; if(!t)return; fetch('api/admin_api.php?action=manage_announcement',{method:'POST',body:new URLSearchParams({type:'add',title:t,content:c})}).then(()=>{alert('å‘å¸ƒæˆåŠŸ'); document.getElementById('annoTitle').value=''; document.getElementById('annoContent').value='';}); }
        function addFaq(){ let q=document.getElementById('faqQ').value,a=document.getElementById('faqA').value; if(!q)return; fetch('api/admin_api.php?action=manage_faq',{method:'POST',body:new URLSearchParams({type:'add',question:q,answer:a})}).then(()=>{alert('æ·»åŠ æˆåŠŸ'); document.getElementById('faqQ').value=''; document.getElementById('faqA').value='';}); }
        function loadFeedbacks(){ fetch('api/admin_api.php?action=get_feedbacks').then(r=>r.json()).then(res=>{ let h='<tr><th>ç”¨æˆ·</th><th>å†…å®¹</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr>'; res.data.forEach(f=>{ h+=`<tr><td>${f.user_phone}</td><td>${f.content}</td><td>${f.create_time}</td><td><button class="btn btn-sm" onclick="readFeed(${f.id})">å·²é˜…</button></td></tr>`; }); document.getElementById('feedbackList').innerHTML=h; }); }
        function readFeed(id){ fetch('api/admin_api.php?action=read_feedback',{method:'POST',body:new URLSearchParams({id})}).then(()=>{loadFeedbacks();}); }

    </script>
</body>
</html>